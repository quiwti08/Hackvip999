--// Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local LocalizationService = game:GetService("LocalizationService")
local LocalPlayer = Players.LocalPlayer
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Lighting = game:GetService("Lighting")
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local StarterGui = game:GetService("StarterGui")
local Camera = Workspace.CurrentCamera
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TextChatService = game:GetService("TextChatService")
local CoreGui = game:GetService("CoreGui")

--// Config
local Config = { 
    CustomPing = 40,
    Buttons = {}, 
    ESPEnabled = false,
    SpeedEnabled = false,
    FlyEnabled = false,
    AimbotEnabled = false,
    FullbrightEnabled = false,
    NoclipEnabled = false,
    ShiftAmount = 0.5,
    SelectedPlayers = {},
    FlySpeed = 35,
    SpeedAmount = 20,
    clickTpEnabled = false,
    MacroLegitEnabled = false,
    AntiLockEnabled = false,
    AntiLockType = "Behind",
    CsyncRandomEnabled = false,
    CsyncOrbitEnabled = false,
    CsyncRadius = 10,
    CsyncHeight = 5,
    CsyncSpeed = 5,
    AutoWallhopEnabled = false,
    SpinbotEnabled = false,
    SpinbotSpeed = 450,
    Prediction = nil,
    OnlyTargetHitbox = false,
    RainbowHitEffectEnabled = true,
    NoSlowdownEnabled = false,
    AutoPredictionEnabled = false,
    CustomFOV = 70,
    CustomFOVEnabled = false,
}

--// Global Variables
getgenv().HitboxSize = 15
getgenv().HitboxTransparency = 0.9
getgenv().HitboxStatus = "OFF"  -- "OFF", "NoVisual", "Visual"
getgenv().TeamCheck = false
getgenv().Aimbot = {
    Status = true,
    Hitpart = "Head",
}
getgenv().CustomAnimEnabled = true

local Keybinds = {}
local AscendEnabled = false
local AscendSpeed = 35  -- M·∫∑c ƒë·ªãnh
local AngelWingEnabled = false
local AngelWingInstances = {}
local AngelWingHrp = nil
local AngelWingColor = Color3.new(1, 1, 1) -- M√†u m·∫∑c ƒë·ªãnh tr·∫Øng
local autoSelect = false
local tbEnabled = true
local fovRadius = 20
local Player = nil
local clickTpTool = nil
local savedWaypoint = nil
local noclipConnection = nil
local spawnPoint = nil
local oldLighting = {
    Brightness = Lighting.Brightness,
    GlobalShadows = Lighting.GlobalShadows,
    FogEnd = Lighting.FogEnd,
    Ambient = Lighting.Ambient,
    OutdoorAmbient = Lighting.OutdoorAmbient,
    ClockTime = Lighting.ClockTime
}
local Notifications = {} -- Danh s√°ch ƒë·ªÉ theo d√µi c√°c th√¥ng b√°o hi·ªán t·∫°i
local lastDt = 1/60
local lastHealth = {}
local lastState = {}
local aimbotButton
local predictionBox
local autoPredictionButton
local hitpartButton
local espButton
local noSlowButton
local speedButton
local flyButton
local boostJumpButton
local antiLockButton
local csyncRandomButton
local csyncOrbitButton
local onlyTargetHitboxButton
local hitboxButton
local angelWingButton
local hugButton
local fovButton
local triggerBotButton
local rainbowHitButton
local antiAfkButton
local antiAfkEnabled = false
local antiAfkLoop
local bangButton
local tpAndStompButton
local invisibleButton
local noclipButton
local loopBringButton
local clickTpButton
local saveWaypointButton
local tpWaypointButton
local spinbotButton
local antiFlingEnabled = false
local antiFlingButton
local flintTouchButton
local rejoinButton
local serverHopButton
local setSpawnButton
local hugEnabled = false
local Play_1, Play_2
local piggyEnabled = false
local piggyConn = nil
local piggyButton
local piggyAnim, piggyTrack
local animEnabled = false
local animTrack = nil
local bangConnection = nil
local invisRunning = false
local IsInvis = false
local invisFix, invisDied
local loopBring = false
local loopBringConn
local hiddenFling = false
local flingPower = 55000
local movel = 0.1
local currentTarget = nil
local csyncPaused = false
local noSlowConnection
local fovConnection
local currentTrack = nil
local animations = {
    happier = "http://www.roblox.com/asset/?id=15609995579",
    happy = "http://www.roblox.com/asset/?id=14352343065",
    siuu = "rbxassetid://120331939816115",
    sturdy = "rbxassetid://128968764985212",
    cutesit = "rbxassetid://97459465855185",
    matching1 = "rbxassetid://102139040629559",
    matching2 = "rbxassetid://110235213168404",
    hug1 = "rbxassetid://105797917228398",
    hug2 = "rbxassetid://118264035209903",
    sit1 = "rbxassetid://94749062881621",
    sit2 = "rbxassetid://110800242342916",
}
local hitParts = {
    "Head", "HumanoidRootPart", "UpperTorso", "LowerTorso", "LeftUpperArm", "LeftLowerArm", "LeftHand",
    "RightUpperArm", "RightLowerArm", "RightHand", "LeftUpperLeg", "LeftLowerLeg", "LeftFoot",
    "RightUpperLeg", "RightLowerLeg", "RightFoot", "Torso", "Left Arm", "Right Arm", "Left Leg", "Right Leg"
}
local antiLockModes = {
    "OFF",
    "Behind",
    "Down",
    "Forward",
    "Left",
    "One",
    "Right",
    "Up",
    "Zero",
}
local hitpartOptions = {"Head", "HumanoidRootPart", "UpperTorso"}  -- Danh s√°ch part
local hitpartIndex = 1
local modeIndex = 1
local espGui = Instance.new("ScreenGui")
espGui.Name = "SafeESP"
espGui.ResetOnSpawn = false
espGui.IgnoreGuiInset = true
espGui.Parent = PlayerGui
local ESPs = {}
local Connections = {}
local FOV_RADIUS = 200
local Character
local InvisibleCharacter
local hrp = nil
local lastPos

--// Helper Functions
local function attachButtonEffects(btn, shrinkPx)
    local orig = btn.Size
    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(200, 200, 200)}):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(180, 180, 180)}):Play()
    end)
    btn.MouseButton1Click:Connect(function()
        local s = shrinkPx or 3
        local toSmall = UDim2.new(orig.X.Scale, math.max(0, orig.X.Offset - s), orig.Y.Scale, math.max(0, orig.Y.Offset - s))
        local t1 = TweenService:Create(btn, TweenInfo.new(0.08), {Size = toSmall})
        local t2 = TweenService:Create(btn, TweenInfo.new(0.08), {Size = orig})
        t1:Play(); t1.Completed:Wait(); t2:Play()
    end)
end

local function makeSmoothDraggable(frame, speed)
    speed = speed or 0.2
    local dragging, dragInput, dragStart, startPos
    local function update(input)
        local delta = input.Position - dragStart
        local goal = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        TweenService:Create(frame, TweenInfo.new(speed, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {Position = goal}):Play()
    end
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then update(input) end
    end)
end

local function CreateButton(parent, name, callback)
    local buttonFrame = Instance.new("Frame")
    buttonFrame.Size = UDim2.new(1, -10, 0, 30)
    buttonFrame.BackgroundTransparency = 1
    buttonFrame.Parent = parent

    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0.7, -5, 1, 0)
    button.BackgroundColor3 = Color3.fromRGB(180, 180, 180)
    button.BackgroundTransparency = 0.2
    button.TextColor3 = Color3.fromRGB(0, 0, 0)
    button.TextSize = 14
    button.Font = Enum.Font.Gotham
    button.Text = name
    button.Parent = buttonFrame
    Instance.new("UICorner", button).CornerRadius = UDim.new(0, 6)
    attachButtonEffects(button, 3)
    button.MouseButton1Click:Connect(callback)

    local keyBox = Instance.new("TextBox")
    keyBox.Size = UDim2.new(0.3, 0, 1, 0)
    keyBox.Position = UDim2.new(0.7, 5, 0, 0)
    keyBox.BackgroundColor3 = Color3.fromRGB(230, 230, 230)
    keyBox.PlaceholderText = "Key"
    keyBox.Text = ""
    keyBox.TextColor3 = Color3.fromRGB(0, 0, 0)
    keyBox.TextSize = 14
    keyBox.Font = Enum.Font.Gotham
    keyBox.ClearTextOnFocus = false
    keyBox.Parent = buttonFrame
    Instance.new("UICorner", keyBox).CornerRadius = UDim.new(0, 6)

    keyBox:GetPropertyChangedSignal("Text"):Connect(function()
        local text = keyBox.Text:upper()
        if text == "" then
            for k, v in pairs(Keybinds) do
                if v == callback then
                    Keybinds[k] = nil
                end
            end
        elseif text == "BUTTON" then
            local screenGui = Instance.new("ScreenGui")
            screenGui.IgnoreGuiInset = true
            screenGui.Parent = game:GetService("CoreGui")

            local screenBtn = Instance.new("TextButton")
            screenBtn.Size = UDim2.new(0, 70, 0, 30)
            screenBtn.Position = UDim2.new(0, 100, 0, 300)
            screenBtn.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
            screenBtn.Text = name
            screenBtn.TextColor3 = Color3.fromRGB(0, 0, 0)
            screenBtn.TextSize = 10
            screenBtn.Font = Enum.Font.GothamBold
            screenBtn.Parent = screenGui
            Instance.new("UICorner", screenBtn).CornerRadius = UDim.new(0, 6)
            makeSmoothDraggable(screenBtn, 0.18)
            attachButtonEffects(screenBtn, 3)
            screenBtn.MouseButton1Click:Connect(callback)
        else
            if Enum.KeyCode[text] then
                Keybinds[text] = nil
                Keybinds[text] = callback
            end
        end
    end)

    return button
end

local function isTouchDevice()
    return UserInputService.TouchEnabled and not (UserInputService.MouseEnabled or UserInputService.KeyboardEnabled)
end

local function createTab(name, parent)
    local btn = Instance.new("TextButton", parent)
    btn.Size = UDim2.new(0, 90, 1, 0) -- Adjusted for 4 tabs
    btn.Text = name
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 14
    btn.BackgroundColor3 = Color3.fromRGB(180, 180, 180)
    btn.TextColor3 = Color3.fromRGB(0, 0, 0)
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    attachButtonEffects(btn, 3)
    return btn
end

local function switchPage(page, pages)
    for _, p in pairs(pages) do
        p.Visible = (p == page)
    end
end

local function UpdatePlayerList(parent)
    for _, child in pairs(parent:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local button = Instance.new("TextButton")
            button.Size = UDim2.new(1, -4, 0, 20)
            button.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            button.BackgroundTransparency = 0.2
            button.TextColor3 = Color3.fromRGB(0, 0, 0)
            button.TextSize = 14
            button.Font = Enum.Font.Gotham
            button.AutoButtonColor = false
            button.Parent = parent

            local function UpdateButtonText()
                local isSelected = Config.SelectedPlayers[player.Name]
                button.Text = (isSelected and "‚úì " or "") .. player.DisplayName  -- Ch·ªâ gi·ªØ DisplayName, x√≥a t√™n g·ªëc ƒë·ªÉ g·ªçn
            end

            button.MouseButton1Click:Connect(function()
                Config.SelectedPlayers[player.Name] = not Config.SelectedPlayers[player.Name]
                UpdateButtonText()
            end)

            attachButtonEffects(button, 3)
            UpdateButtonText()
        end
    end
end

local function CreateScriptItem(name, url, parent)
    local itemFrame = Instance.new("Frame", parent)
    itemFrame.Size = UDim2.new(1, 0, 0, 35)
    itemFrame.BackgroundTransparency = 0.2
    itemFrame.BackgroundColor3 = Color3.fromRGB(230, 230, 230)

    local nameLabel = Instance.new("TextLabel", itemFrame)
    nameLabel.Size = UDim2.new(0.7, 0, 1, 0)
    nameLabel.Position = UDim2.new(0, 5, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = name
    nameLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.TextSize = 16
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left

    local runBtn = Instance.new("TextButton", itemFrame)
    runBtn.Size = UDim2.new(0.3, -10, 1, -4)
    runBtn.Position = UDim2.new(0.7, 5, 0, 2)
    runBtn.BackgroundColor3 = Color3.fromRGB(180, 180, 180)
    runBtn.Text = "Run"
    runBtn.TextColor3 = Color3.fromRGB(0, 0, 0)
    runBtn.TextSize = 16
    runBtn.Font = Enum.Font.GothamBold
    Instance.new("UICorner", runBtn).CornerRadius = UDim.new(0, 6)
    attachButtonEffects(runBtn, 3)
    runBtn.MouseButton1Click:Connect(function()
        loadstring(game:HttpGet(url))()
    end)

    Instance.new("UICorner", itemFrame).CornerRadius = UDim.new(0, 6)
    return itemFrame
end

local function mkLine(parent)
    local l = Instance.new("TextLabel")
    l.Size = UDim2.new(1, -10, 0, 22)
    l.BackgroundTransparency = 1
    l.Font = Enum.Font.Gotham
    l.TextSize = 14
    l.TextColor3 = Color3.fromRGB(200, 200, 200)
    l.TextXAlignment = Enum.TextXAlignment.Left
    l.TextWrapped = false
    l.ClipsDescendants = true
    l.Parent = parent
    return l
end

local function sendNotification(title, text, duration)
    -- T·∫°o ScreenGui m·ªõi cho th√¥ng b√°o
    local notifGui = Instance.new("ScreenGui")
    notifGui.Name = "DhuyxNotification_" .. tostring(tick())
    notifGui.Parent = game:GetService("CoreGui")
    notifGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    notifGui.DisplayOrder = 999999 - #Notifications -- Gi·∫£m DisplayOrder cho th√¥ng b√°o m·ªõi
    notifGui.IgnoreGuiInset = true
    notifGui.ResetOnSpawn = false

    -- T√≠nh to√°n v·ªã tr√≠ d·ª±a tr√™n s·ªë l∆∞·ª£ng th√¥ng b√°o hi·ªán t·∫°i
    local offsetY = 20 + (#Notifications * 80) -- M·ªói th√¥ng b√°o c√°ch nhau 80 pixel (70 pixel chi·ªÅu cao + 10 pixel kho·∫£ng c√°ch)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 280, 0, 70)
    frame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    frame.BorderSizePixel = 0
    frame.AnchorPoint = Vector2.new(1, 1)
    frame.Position = UDim2.new(1, -20, 1, -offsetY) -- ƒê·∫∑t v·ªã tr√≠, th√¥ng b√°o m·ªõi ·ªü d∆∞·ªõi
    frame.Transparency = 1 -- Ban ƒë·∫ßu trong su·ªët cho hi·ªáu ·ª©ng fade-in
    frame.Parent = notifGui

    -- Bo g√≥c
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame

    -- Gradient
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(60, 60, 60)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(40, 40, 40))
    }
    gradient.Rotation = 90
    gradient.Parent = frame

    -- Shadow
    local shadow = Instance.new("ImageLabel")
    shadow.Size = UDim2.new(1, 20, 1, 20)
    shadow.Position = UDim2.new(0, -10, 0, -10)
    shadow.Image = "rbxassetid://1316045217"
    shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
    shadow.ImageTransparency = 0.6
    shadow.ScaleType = Enum.ScaleType.Slice
    shadow.SliceCenter = Rect.new(10, 10, 118, 118)
    shadow.ZIndex = -1
    shadow.BackgroundTransparency = 1
    shadow.Parent = frame

    -- Title
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -10, 0, 25)
    titleLabel.Position = UDim2.new(0, 5, 0, 5)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = title or "DhuyxDtuyen"
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 16
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.TextTruncate = Enum.TextTruncate.AtEnd
    titleLabel.Parent = frame

    -- Text
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, -10, 1, -35)
    textLabel.Position = UDim2.new(0, 5, 0, 30)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = text or "Notification"
    textLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    textLabel.Font = Enum.Font.Gotham
    textLabel.TextSize = 14
    textLabel.TextWrapped = true
    textLabel.TextXAlignment = Enum.TextXAlignment.Left
    textLabel.TextTruncate = Enum.TextTruncate.AtEnd
    textLabel.Parent = frame

    -- Th√™m th√¥ng b√°o v√†o danh s√°ch
    table.insert(Notifications, notifGui)

    -- Fade in animation
    local fadeIn = TweenService:Create(frame, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Transparency = 0})
    fadeIn:Play()

    -- Fade out v√† x√≥a
    task.spawn(function()
        task.wait(duration or 3)
        local fadeOut = TweenService:Create(frame, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {Transparency = 1})
        fadeOut:Play()
        fadeOut.Completed:Connect(function()
            -- X√≥a th√¥ng b√°o kh·ªèi danh s√°ch v√† h·ªßy n√≥
            for i, gui in ipairs(Notifications) do
                if gui == notifGui then
                    table.remove(Notifications, i)
                    break
                end
            end
            notifGui:Destroy()

            -- C·∫≠p nh·∫≠t l·∫°i v·ªã tr√≠ c·ªßa c√°c th√¥ng b√°o c√≤n l·∫°i
            for i, gui in ipairs(Notifications) do
                local frame = gui:FindFirstChildOfClass("Frame")
                if frame then
                    local newOffsetY = 20 + ((i - 1) * 80) -- C·∫≠p nh·∫≠t v·ªã tr√≠
                    local tween = TweenService:Create(frame, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Position = UDim2.new(1, -20, 1, -newOffsetY)})
                    tween:Play()
                end
            end
        end)
    end)
end

local function GetPing()
    local stats = game:GetService("Stats"):FindFirstChild("Network")
    local data = stats and stats:FindFirstChild("DataPing")
    return data and math.clamp(data:GetValue(), 10, 300) or 40
end

local function GetPredFromPing(p)
    if p < 20 then return 0.119
    elseif p < 30 then return 0.122
    elseif p < 40 then return 0.126
    elseif p < 50 then return 0.130
    elseif p < 60 then return 0.133
    elseif p < 70 then return 0.136
    elseif p < 80 then return 0.139
    elseif p < 90 then return 0.143
    elseif p < 100 then return 0.146
    elseif p < 150 then return 0.150
    elseif p < 200 then return 0.155
    else return 0.165 + (p - 200) / 1000  -- TƒÉng d·∫ßn cho ping cao
    end
end

local function CalculateVIPPrediction(part, ping)
    if not part or not part:IsA("BasePart") then return nil end
    local velocity = part.Velocity
    local pred = GetPredFromPing(ping)  -- T√≠nh scalar pred t·ª´ ping
    return part.Position + velocity * pred
end

local function applyNoSlowdown()
    if not Config.NoSlowdownEnabled then return end

    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    if not (hrp and hum) then return end

    -- Ki·ªÉm tra tr·∫°ng th√°i gi·∫£m t·ªëc (reload, punch, v.v.)
    local bodyEffects = char:FindFirstChild("BodyEffects")
    local isSlowed = false
    if bodyEffects then
        local reload = bodyEffects:FindFirstChild("Reload")
        local movement = bodyEffects:FindFirstChild("Movement")
        -- Ki·ªÉm tra tr·∫°ng th√°i reload ho·∫∑c movement b·ªã gi·ªõi h·∫°n
        isSlowed = (reload and reload.Value) or (movement and movement.Value < 1)
    end

    -- N·∫øu ƒëang b·ªã gi·∫£m t·ªëc ho·∫∑c t·ªëc ƒë·ªô nh·ªè h∆°n b√¨nh th∆∞·ªùng
    if isSlowed or hum.WalkSpeed < 16 then
        local moveDirection = hum.MoveDirection
        if moveDirection.Magnitude > 0 then
            -- Di chuy·ªÉn nh√¢n v·∫≠t b·∫±ng CFrame v·ªõi t·ªëc ƒë·ªô t∆∞∆°ng ƒë∆∞∆°ng WalkSpeed 16
            local speed = 20 / 60 -- T·ªëc ƒë·ªô 16 stud/s, chia cho 60 frame/s
            hrp.CFrame = hrp.CFrame + moveDirection * speed
        end
    end
end

local function isAlive(plr)
    if not plr or not plr.Character then return false end
    local hum = plr.Character:FindFirstChildOfClass("Humanoid")
    if not hum or hum.Health <= 0 then
        return false
    end

    -- Check ri√™ng cho Da Hood (BodyEffects)
    local be = plr.Character:FindFirstChild("BodyEffects")
    if be then
        local ko = be:FindFirstChild("K.O")
        local grabbed = be:FindFirstChild("GRABBING_CONSTRAINT")
        if (ko and ko.Value) or (grabbed and grabbed.Value) then
            return false
        end
    end

    return true
end

local function getClosestSelected()
    local closest, dist = nil, math.huge
    local myChar = LocalPlayer.Character
    local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
    if not myHRP then return nil end

    for name, selected in pairs(Config.SelectedPlayers or {}) do
        if selected then
            local plr = Players:FindFirstChild(name)
            if plr and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                local d = (myHRP.Position - plr.Character.HumanoidRootPart.Position).Magnitude
                if d < dist then
                    dist = d
                    closest = plr
                end
            end
        end
    end
    return closest
end

local function GetClosestTarget()
    local closestPlayer = nil
    local closestDistance = math.huge
    local myChar = LocalPlayer.Character
    local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
    if not myHRP then
        print("Debug: No local HumanoidRootPart found")
        return nil
    end
    local localPos = myHRP.Position

    for playerName, isSelected in pairs(Config.SelectedPlayers or {}) do
        if isSelected then
            local player = Players:FindFirstChild(playerName)
            if player and isAlive(player) then -- S·ª≠ d·ª•ng h√†m isAlive ƒë√£ c√≥
                local targetHRP = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                if targetHRP then
                    local distance = (localPos - targetHRP.Position).Magnitude
                    if distance < closestDistance then
                        closestDistance = distance
                        closestPlayer = player
                    end
                end
            end
        end
    end

    if not closestPlayer then
        print("Debug: No valid target found")
    else
        print("Debug: Selected target:", closestPlayer.Name)
    end
    return closestPlayer
end

local function createLabeledBox(parent, labelText, default, onChange, pos)
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1/3 - 0.02, 0, 1, 0)
    container.Position = pos
    container.BackgroundTransparency = 1
    container.Parent = parent

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, 10)
    label.BackgroundTransparency = 1
    label.Text = labelText
    label.TextSize = 10
    label.TextColor3 = Color3.fromRGB(180, 180, 180)
    label.Font = Enum.Font.Gotham
    label.Parent = container

    local tb = Instance.new("TextBox")
    tb.Size = UDim2.new(1, 0, 0, 20)
    tb.Position = UDim2.new(0, 0, 0, 12)
    tb.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    tb.TextColor3 = Color3.new(1, 1, 1)
    tb.Text = tostring(default)
    tb.PlaceholderText = labelText
    tb.ClearTextOnFocus = false
    tb.Font = Enum.Font.GothamBold
    tb.TextSize = 12
    tb.Parent = container
    Instance.new("UICorner", tb).CornerRadius = UDim.new(0, 4)

    tb.FocusLost:Connect(function()
        local num = tonumber(tb.Text)
        if num then
            onChange(num)
        else
            tb.Text = tostring(default)
        end
    end)
end

local function applyFOV()
    if Config.CustomFOVEnabled then
        Workspace.CurrentCamera.FieldOfView = Config.CustomFOV
        print("Debug: Applied FOV =", Config.CustomFOV)
    else
        Workspace.CurrentCamera.FieldOfView = 70 -- Kh√¥i ph·ª•c FOV m·∫∑c ƒë·ªãnh
        print("Debug: Restored default FOV = 70")
    end
end

local function stopAnim()
    if Play_1 then Play_1:Stop() end
    if Play_2 then Play_2:Stop() end
    Play_1, Play_2 = nil, nil
end

local function stopPiggy()
    if piggyConn then
        piggyConn:Disconnect()
        piggyConn = nil
    end
    if piggyTrack then
        piggyTrack:Stop()
        piggyTrack = nil
    end
    local myChar = LocalPlayer.Character
    local myHum = myChar and myChar:FindFirstChildOfClass("Humanoid")
    if myHum then myHum.Sit = false end
    piggyEnabled = false
    piggyButton.Text = "Piggyback: OFF"
end

local function startPiggy(target)
    local myChar = LocalPlayer.Character
    local myHum  = myChar and myChar:FindFirstChildOfClass("Humanoid")
    local myHRP  = myChar and myChar:FindFirstChild("HumanoidRootPart")
    local head   = target.Character and target.Character:FindFirstChild("Head")

    if not (myHum and myHRP and head) then
        stopPiggy()
        return
    end

    -- √©p nh√¢n v·∫≠t v√†o tr·∫°ng th√°i ng·ªìi
    myHum.Sit = true

    -- load animation piggyback
    piggyAnim = Instance.new("Animation")
    piggyAnim.AnimationId = "rbxassetid://115900505866868"
    piggyTrack = myHum:LoadAnimation(piggyAnim)
    piggyTrack:Play()

    piggyButton.Text = ("Piggyback: ON (%s)"):format(target.Name)
    sendNotification("Piggyback", "ƒêang c√µng " .. target.Name)

    piggyConn = RunService.Heartbeat:Connect(function()
        local valid = piggyEnabled
            and target.Character
            and target.Character:FindFirstChild("Head")
            and myHRP
            and myHRP.Parent

        if not valid then
            stopPiggy()
            return
        end

        local tHead = target.Character.Head
        myHRP.CFrame = tHead.CFrame * CFrame.new(0, -1.6, 0.7)

        -- ch·ªëng tr√¥i
        pcall(function()
            myHRP.AssemblyLinearVelocity = Vector3.zero
            myHRP.AssemblyAngularVelocity = Vector3.zero
        end)
    end)
end

local function fadeColor()
    local t = tick() * 2 -- s·ªë c√†ng l·ªõn th√¨ rainbow c√†ng nhanh
    return Color3.fromHSV((t % 1), 1, 1)
end

local function stopAnimAndTp()
    if animTrack then
        animTrack:Stop()
        animTrack = nil
    end
    if bangConnection then
        bangConnection:Disconnect()
        bangConnection = nil
    end
    animEnabled = false
end

local function Respawn()
    if IsInvis then
        pcall(function()
            LocalPlayer.Character = Character
            task.wait()
            Character.Parent = workspace
            Character:FindFirstChildWhichIsA("Humanoid"):Destroy()
            IsInvis = false
            InvisibleCharacter.Parent = nil
            invisRunning = false
        end)
    else
        pcall(function()
            LocalPlayer.Character = Character
            task.wait()
            Character.Parent = workspace
            Character:FindFirstChildWhichIsA("Humanoid"):Destroy()
            TurnVisible()
        end)
    end
end

local function TurnVisible()
    if not IsInvis then return end
    if invisFix then invisFix:Disconnect() end
    if invisDied then invisDied:Disconnect() end

    local CF_1 = LocalPlayer.Character.HumanoidRootPart.CFrame
    InvisibleCharacter.Parent = Lighting
    LocalPlayer.Character = Character
    Character.Parent = workspace
    Character.HumanoidRootPart.CFrame = CF_1
    IsInvis = false
    LocalPlayer.Character.Animate.Disabled = true
    LocalPlayer.Character.Animate.Disabled = false

    -- üîë Reset Camera khi t·∫Øt invis
    task.wait(.1)
    Workspace.CurrentCamera.CameraSubject = Character:FindFirstChildWhichIsA("Humanoid")
    Workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
    LocalPlayer.CameraMinZoomDistance = 0.5
    LocalPlayer.CameraMaxZoomDistance = 400
    LocalPlayer.CameraMode = "Classic"

    invisRunning = false
end

local function ToggleInvisible()
    if invisRunning then return end

    if not IsInvis then
        invisRunning = true
        LocalPlayer = Players.LocalPlayer
        repeat task.wait(.1) until LocalPlayer.Character
        Character = LocalPlayer.Character
        Character.Archivable = true

        InvisibleCharacter = Character:Clone()
        InvisibleCharacter.Parent = Lighting
        InvisibleCharacter.Name = ""

        -- Check r∆°i xu·ªëng void
        local Void = workspace.FallenPartsDestroyHeight
        invisFix = RunService.Stepped:Connect(function()
            pcall(function()
                local Y = LocalPlayer.Character.HumanoidRootPart.Position.Y
                if tostring(Void):find"-" then
                    if Y <= Void then Respawn() end
                else
                    if Y >= Void then Respawn() end
                end
            end)
        end)

        -- L√†m m·ªù clone
        for _,v in pairs(InvisibleCharacter:GetDescendants()) do
            if v:IsA("BasePart") then
                v.Transparency = (v.Name == "HumanoidRootPart") and 1 or 0.5
            end
        end

        -- Handle ch·∫øt
        invisDied = InvisibleCharacter:FindFirstChildOfClass("Humanoid").Died:Connect(function()
            Respawn()
            invisDied:Disconnect()
        end)

        -- Swap sang invisible
        IsInvis = true
        local CF_1 = Character.HumanoidRootPart.CFrame
        Character:MoveTo(Vector3.new(0,math.pi*1000000,0))
        Workspace.CurrentCamera.CameraType = Enum.CameraType.Scriptable
        task.wait(.1)
        Workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
        Character.Parent = Lighting
        InvisibleCharacter.Parent = Workspace
        InvisibleCharacter.HumanoidRootPart.CFrame = CF_1
        LocalPlayer.Character = InvisibleCharacter

        task.wait(.1)
        Workspace.CurrentCamera.CameraSubject = LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid")
        Workspace.CurrentCamera.CameraType = "Custom"
        LocalPlayer.CameraMinZoomDistance = 0.5
        LocalPlayer.CameraMaxZoomDistance = 400
        LocalPlayer.CameraMode = "Classic"
        LocalPlayer.Character.Animate.Disabled = true
        LocalPlayer.Character.Animate.Disabled = false

        invisRunning = false -- cho ph√©p toggle l·∫ßn n·ªØa
    else
        TurnVisible()
        IsInvis = false
        invisRunning = false
    end
end

local function stopAnimation()
    if currentTrack then
        currentTrack:Stop()
        currentTrack = nil
    end
end

local function playAnimation(animId)
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChildOfClass("Humanoid") then return end
    local hum = char:FindFirstChildOfClass("Humanoid")

    -- ƒêang di chuy·ªÉn th√¨ kh√¥ng ph√°t
    if hum.MoveDirection.Magnitude > 0 then return end

    -- Ng·ª´ng animation c≈© n·∫øu c√≥
    stopAnimation()

    -- T·∫°o animator n·∫øu ch∆∞a c√≥
    local animator = hum:FindFirstChildOfClass("Animator") or Instance.new("Animator", hum)

    local anim = Instance.new("Animation")
    anim.AnimationId = animId
    local track = animator:LoadAnimation(anim)
    track:Play()
    currentTrack = track
end

local function updateCharacterRefs()
    character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    humanoid = character:WaitForChild("Humanoid")
    rootPart = character:WaitForChild("HumanoidRootPart")
end

local function isWallInFront()
    if not rootPart then return false end
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {character}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

    local origin = rootPart.Position + Vector3.new(0, 2, 0) -- raycast t·ª´ ng·ª±c
    local direction = rootPart.CFrame.LookVector * 2 -- kho·∫£ng c√°ch 2 studs
    local result = Workspace:Raycast(origin, direction, raycastParams)

    return result and result.Instance ~= nil
end

local function performWallHop()
    if not Config.AutoWallhopEnabled or isPerformingWallHop or not humanoid or not rootPart then return end
    isPerformingWallHop = true

    while Config.AutoWallhopEnabled and isWallInFront() do
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
        rootPart.AssemblyLinearVelocity = Vector3.new(0, 60, 0) -- l·ª±c nh·∫£y
        rootPart.CFrame = rootPart.CFrame * CFrame.Angles(0, math.rad(-35), 0)
        task.wait(0.4)
    end

    isPerformingWallHop = false
end

local function giveClickTpTool()
    if clickTpTool then clickTpTool:Destroy() end
    clickTpTool = Instance.new("Tool")
    clickTpTool.RequiresHandle = false
    clickTpTool.Name = "ClickTP"
    clickTpTool.Parent = LocalPlayer.Backpack

    clickTpTool.Activated:Connect(function()
        local mouse = LocalPlayer:GetMouse()
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            if mouse and mouse.Hit then
                local targetPos = mouse.Hit.p + Vector3.new(0, 3, 0) -- c√°ch m·∫∑t ƒë·∫•t 3 stud
                LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(targetPos)
            end
        end
    end)
end

local function protectHRP()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        hrp = LocalPlayer.Character.HumanoidRootPart
    end
end

local function getDHState(plr)
    if not plr.Character then return "None" end
    local hum = plr.Character:FindFirstChildOfClass("Humanoid")
    if not hum or hum.Health <= 0 then
        return "Dead"
    end

    local be = plr.Character:FindFirstChild("BodyEffects")
    if be then
        local ko = be:FindFirstChild("K.O")
        if ko and ko.Value then
            return "K.O"
        end
        local grab = be:FindFirstChild("GRABBING_CONSTRAINT")
        if grab and grab.Parent then
            return "Grab"
        end
    end

    return "Alive"
end

local function checkPlayerState(plr)
    local state = getDHState(plr)
    if lastState[plr] ~= state then
        lastState[plr] = state
        -- Th√¥ng b√°o 1 l·∫ßn khi ƒë·ªïi tr·∫°ng th√°i
        sendNotification(plr.DisplayName, "is now " .. state, 3)
    end
end

local function flingLoop()
    local lp = Players.LocalPlayer
    local hrp, c, vel

    task.spawn(function()
        while true do
            RunService.Heartbeat:Wait()
            if hiddenFling then
                while hiddenFling and not (c and c.Parent and hrp and hrp.Parent) do
                    RunService.Heartbeat:Wait()
                    c = lp.Character
                    hrp = c and c:FindFirstChild("HumanoidRootPart")
                end

                if hiddenFling and hrp then
                    vel = hrp.Velocity
                    hrp.Velocity = vel * flingPower + Vector3.new(0, flingPower, 0)
                    RunService.RenderStepped:Wait()
                    if hrp.Parent then
                        hrp.Velocity = vel
                    end
                    RunService.Stepped:Wait()
                    if hrp.Parent then
                        hrp.Velocity = vel + Vector3.new(0, movel, 0)
                        movel = movel * -1
                    end
                end
            end
        end
    end)
end

local function getServers(placeId)
    local servers = {}
    local cursor = ""
    repeat
        local url = "https://games.roblox.com/v1/games/" .. placeId .. "/servers/Public?sortOrder=Asc&limit=100"
        if cursor ~= "" then url = url .. "&cursor=" .. cursor end
        local success, response = pcall(function()
            return HttpService:JSONDecode(game:HttpGet(url))
        end)
        if success then
            for _, s in ipairs(response.data or {}) do
                if s.id ~= game.JobId and s.playing < s.maxPlayers then  -- B·ªè server hi·ªán t·∫°i v√† server ƒë·∫ßy
                    table.insert(servers, s)
                end
            end
            cursor = response.nextPageCursor
        else
            cursor = nil
        end
    until not cursor
    return servers
end

local function destroyAw()
    for _, inst in pairs(AngelWingInstances) do
        pcall(function() inst:Destroy() end)
    end
    AngelWingInstances = {}
end

local function createAw()
    local character = game.Players.LocalPlayer.Character
    if not character then return end
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    AngelWingHrp = (humanoid.RigType == Enum.HumanoidRigType.R15 and character:FindFirstChild("UpperTorso")) or
                   (humanoid.RigType == Enum.HumanoidRigType.R6 and character:FindFirstChild("Torso"))
    if not AngelWingHrp then return end

    destroyAw()

    -- Attachment1 t·∫°i (0, 4.25, 0)
    local att1 = Instance.new("Attachment")
    att1.Name = "AngelAttachment1"
    att1.CFrame = CFrame.new(0, 4.25, 0)
    att1.Parent = AngelWingHrp
    table.insert(AngelWingInstances, att1)

    -- ParticleEmitter1 trong att1
    local pe1 = Instance.new("ParticleEmitter")
    pe1.Name = "AngelParticle1"
    pe1.Acceleration = Vector3.new(0, -6, 0)
    pe1.Brightness = 1
    pe1.Color = ColorSequence.new(AngelWingColor)
    pe1.Drag = 0
    pe1.EmissionDirection = Enum.NormalId.Bottom
    pe1.Enabled = true
    pe1.Lifetime = NumberRange.new(1, 2)
    pe1.LightEmission = 1
    pe1.LightInfluence = 1
    pe1.LockedToPart = true
    pe1.Orientation = Enum.ParticleOrientation.FacingCamera
    pe1.Rate = 50
    pe1.RotSpeed = NumberRange.new(-100, 100)
    pe1.Rotation = NumberRange.new(-360, 360)
    pe1.Size = NumberSequence.new({NumberSequenceKeypoint.new(0, 0.5, 0.3), NumberSequenceKeypoint.new(1, 0.5, 0.3)})
    pe1.Speed = NumberRange.new(2.5, 2.5)
    pe1.SpreadAngle = Vector2.new(0, 360)
    pe1.Squash = NumberSequence.new({NumberSequenceKeypoint.new(0, 0), NumberSequenceKeypoint.new(1, 0)})
    pe1.Texture = "rbxassetid://7511321694"
    pe1.TimeScale = 1
    pe1.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 1),
        NumberSequenceKeypoint.new(0.1, 0),
        NumberSequenceKeypoint.new(0.3, 0),
        NumberSequenceKeypoint.new(0.8, 0),
        NumberSequenceKeypoint.new(1, 1)
    })
    pe1.VelocityInheritance = 0
    pe1.WindAffectsDrag = false
    pe1.ZOffset = 0
    pe1.Parent = att1
    table.insert(AngelWingInstances, pe1)

    -- ParticleEmitter2 trong att1
    local pe2 = Instance.new("ParticleEmitter")
    pe2.Name = "AngelParticle2"
    pe2.Acceleration = Vector3.new(0, -6, 0)
    pe2.Brightness = 1
    pe2.Color = ColorSequence.new(AngelWingColor)
    pe2.Drag = 0
    pe2.EmissionDirection = Enum.NormalId.Bottom
    pe2.Enabled = true
    pe2.Lifetime = NumberRange.new(1, 2)
    pe2.LightEmission = 1
    pe2.LightInfluence = 1
    pe2.LockedToPart = true
    pe2.Orientation = Enum.ParticleOrientation.FacingCamera
    pe2.Rate = 100
    pe2.RotSpeed = NumberRange.new(-100, 100)
    pe2.Rotation = NumberRange.new(-360, 360)
    pe2.Size = NumberSequence.new({NumberSequenceKeypoint.new(0, 0.5, 0.3), NumberSequenceKeypoint.new(1, 0.5, 0.3)})
    pe2.Speed = NumberRange.new(2.5, 2.5)
    pe2.SpreadAngle = Vector2.new(0, 360)
    pe2.Squash = NumberSequence.new({NumberSequenceKeypoint.new(0, 0), NumberSequenceKeypoint.new(1, 0)})
    pe2.Texture = "rbxassetid://1084976679"
    pe2.TimeScale = 1
    pe2.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 1),
        NumberSequenceKeypoint.new(0.2, 0),
        NumberSequenceKeypoint.new(0.8, 0),
        NumberSequenceKeypoint.new(1, 1)
    })
    pe2.VelocityInheritance = 0
    pe2.WindAffectsDrag = false
    pe2.ZOffset = 0
    pe2.Parent = att1
    table.insert(AngelWingInstances, pe2)

    -- Attachment2 t·∫°i (0, 0.75, 0.5)
    local att2 = Instance.new("Attachment")
    att2.Name = "AngelAttachment2"
    att2.CFrame = CFrame.new(0, 0.75, 0.5)
    att2.Parent = AngelWingHrp
    table.insert(AngelWingInstances, att2)

    -- Attachment3 t·∫°i (-5.25, 0, 2)
    local att3 = Instance.new("Attachment")
    att3.Name = "AngelAttachment3"
    att3.CFrame = CFrame.new(-5.25, 0, 2) * CFrame.fromMatrix(Vector3.new(0,0,0), Vector3.new(0.866025388, 0, 0.5), Vector3.new(0,1,0), Vector3.new(-0.5, 0, 0.866025388))
    att3.Parent = AngelWingHrp
    table.insert(AngelWingInstances, att3)

    -- Attachment4 t·∫°i (5.25, 0, 2)
    local att4 = Instance.new("Attachment")
    att4.Name = "AngelAttachment4"
    att4.CFrame = CFrame.new(5.25, 0, 2) * CFrame.fromMatrix(Vector3.new(0,0,0), Vector3.new(0.866025388, 0, -0.5), Vector3.new(0,1,0), Vector3.new(0.5, 0, 0.866025388))
    att4.Parent = AngelWingHrp
    table.insert(AngelWingInstances, att4)

    -- Beam1: att2 ƒë·∫øn att3
    local beam1 = Instance.new("Beam")
    beam1.Name = "AngelBeam1"
    beam1.Attachment0 = att2
    beam1.Attachment1 = att3
    beam1.Brightness = 1
    beam1.Color = ColorSequence.new(AngelWingColor)
    beam1.CurveSize0 = 2
    beam1.CurveSize1 = 2
    beam1.Enabled = true
    beam1.FaceCamera = false
    beam1.LightEmission = 1
    beam1.LightInfluence = 1
    beam1.Segments = 10
    beam1.Texture = "rbxassetid://9544400688"
    beam1.TextureLength = 1
    beam1.TextureMode = Enum.TextureMode.Stretch
    beam1.TextureSpeed = 0
    beam1.Transparency = NumberSequence.new({NumberSequenceKeypoint.new(0, 0), NumberSequenceKeypoint.new(1, 0)})
    beam1.Width0 = 4
    beam1.Width1 = 6
    beam1.ZOffset = 0
    beam1.Parent = AngelWingHrp
    table.insert(AngelWingInstances, beam1)

    -- Beam2: att2 ƒë·∫øn att4
    local beam2 = Instance.new("Beam")
    beam2.Name = "AngelBeam2"
    beam2.Attachment0 = att2
    beam2.Attachment1 = att4
    beam2.Brightness = 1
    beam2.Color = ColorSequence.new(AngelWingColor)
    beam2.CurveSize0 = -2
    beam2.CurveSize1 = -2
    beam2.Enabled = true
    beam2.FaceCamera = false
    beam2.LightEmission = 1
    beam2.LightInfluence = 1
    beam2.Segments = 10
    beam2.Texture = "rbxassetid://9544400688"
    beam2.TextureLength = 1
    beam2.TextureMode = Enum.TextureMode.Stretch
    beam2.TextureSpeed = 0
    beam2.Transparency = NumberSequence.new({NumberSequenceKeypoint.new(0, 0), NumberSequenceKeypoint.new(1, 0)})
    beam2.Width0 = 4
    beam2.Width1 = 6
    beam2.ZOffset = 0
    beam2.Parent = AngelWingHrp
    table.insert(AngelWingInstances, beam2)

    -- PointLight
    local pl = Instance.new("PointLight")
    pl.Name = "AngelPointLight"
    pl.Brightness = 4
    pl.Color = AngelWingColor
    pl.Enabled = true
    pl.Range = 5
    pl.Shadows = false
    pl.Parent = AngelWingHrp
    table.insert(AngelWingInstances, pl)
end

local function updateAwColor(newColor)
    AngelWingColor = newColor
    if AngelWingEnabled then
        for _, inst in pairs(AngelWingInstances) do
            if inst:IsA("ParticleEmitter") or inst:IsA("Beam") then
                inst.Color = ColorSequence.new(AngelWingColor)
            elseif inst:IsA("PointLight") then
                inst.Color = AngelWingColor
            end
        end
    end
end

local function IsValidTarget(player)
    if not player 
        or not player.Character 
        or not player.Character:FindFirstChild("Humanoid") 
        or not player.Character:FindFirstChild("HumanoidRootPart") 
        or player.Character.Humanoid.Health <= 0 then
        return false
    end

    return true
end

local function IsPlayerKnockedOrGrabbed(player)
    -- Ki·ªÉm tra xem game c√≥ folder BodyEffects kh√¥ng (ƒë·∫∑c tr∆∞ng c·ªßa Da Hood)
    local bodyEffects = player.Character and player.Character:FindFirstChild("BodyEffects")
    if not bodyEffects then
        return false -- N·∫øu kh√¥ng c√≥ BodyEffects, b·ªè qua (game kh√¥ng ph·∫£i Da Hood)
    end

    local ko = bodyEffects:FindFirstChild("K.O")
    local grabbed = bodyEffects:FindFirstChild("GRABBING_CONSTRAINT")
    return (ko and ko.Value) or (grabbed and grabbed.Value)
end

local function CreateESP(player)
    if ESPs[player] or player == LocalPlayer then return end
    local label = Instance.new("TextLabel")
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255, 179, 186)
    label.TextSize = 16
    label.Font = Enum.Font.GothamBold
    label.Text = player.DisplayName
    label.TextStrokeTransparency = 0.5
    label.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    label.Size = UDim2.new(0, 200, 0, 20)
    label.AnchorPoint = Vector2.new(0.5, 0.5)
    label.Position = UDim2.new(0.5, 0, 0.5, 0)
    label.Visible = false
    label.Parent = espGui

    local highlight = Instance.new("Highlight")
    highlight.Enabled = false
    highlight.FillTransparency = 0.6
    highlight.OutlineTransparency = 0.2
    highlight.FillColor = Color3.fromRGB(55, 55, 55)
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.Adornee = player.Character
    highlight.Parent = espGui

    ESPs[player] = { label = label, highlight = highlight }
end

local function RemoveESP(player)
    if ESPs[player] then
        pcall(function()
            ESPs[player].label:Destroy()
            ESPs[player].highlight:Destroy()
        end)
        ESPs[player] = nil
    end
end

local function UpdateESP()
    if not Config.ESPEnabled then
        for _, v in pairs(ESPs) do
            v.label.Visible = false
            v.highlight.Enabled = false
        end
        return
    end
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and IsValidTarget(player) then
            local character = player.Character
            local head = character:FindFirstChild("Head")
            if head then
                CreateESP(player)
                local headPos = head.Position
                local screenPos, onScreen = Camera:WorldToViewportPoint(headPos)
                local esp = ESPs[player]
                if esp then
                    local isSelected = Config.SelectedPlayers[player.Name]
                    -- Ki·ªÉm tra tr·∫°ng th√°i K.O ho·∫∑c grab
                    local isKnockedOrGrabbed = IsPlayerKnockedOrGrabbed(player)
                    if isKnockedOrGrabbed then
                        -- M√†u v√†ng cho K.O ho·∫∑c grab
                        esp.label.TextColor3 = Color3.fromRGB(255, 255, 0)
                        esp.highlight.FillColor = Color3.fromRGB(255, 255, 0)
                        esp.highlight.OutlineColor = Color3.fromRGB(255, 255, 0)
                    else
                        -- M√†u cho ng∆∞·ªùi ƒë∆∞·ª£c ch·ªçn ho·∫∑c kh√¥ng ch·ªçn
                        esp.label.TextColor3 = isSelected and Color3.fromRGB(50, 50, 50) or Color3.fromRGB(255, 255, 255)
                        esp.highlight.FillColor = isSelected and Color3.fromRGB(50, 50, 50) or Color3.fromRGB(255, 255, 255)
                        esp.highlight.OutlineColor = Color3.fromRGB(255, 255, 255) -- Gi·ªØ outline tr·∫Øng
                    end
                    if onScreen then
                        esp.label.Visible = true
                        esp.label.Position = UDim2.new(0, screenPos.X, 0, screenPos.Y - 20)
                        esp.highlight.Enabled = true
                    else
                        esp.label.Visible = false
                        esp.highlight.Enabled = false
                    end
                end
            else
                RemoveESP(player)
            end
        else
            RemoveESP(player)
        end
    end
end

local function UpdateAngelWing()
    if AngelWingEnabled then
        local char = game.Players.LocalPlayer.Character
        if char and char:FindFirstChildOfClass("Humanoid") then
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum.MoveDirection.Magnitude > 0 then
                for _, inst in pairs(AngelWingInstances) do
                    if inst:IsA("ParticleEmitter") or inst:IsA("Beam") or inst:IsA("PointLight") then
                        inst.Enabled = false
                    end
                end
            else
                for _, inst in pairs(AngelWingInstances) do
                    if inst:IsA("ParticleEmitter") or inst:IsA("Beam") or inst:IsA("PointLight") then
                        inst.Enabled = true
                    end
                end
            end
        end
    end
end

local function UpdateSpeed()
    if Config.SpeedEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local root = LocalPlayer.Character.HumanoidRootPart
        local humanoid = LocalPlayer.Character.Humanoid
        local moveDirection = humanoid.MoveDirection
        local speedAmount = Config.SpeedAmount / 8
        root.CFrame = root.CFrame + moveDirection * speedAmount
    end
end

local function UpdateFly(deltaTime)
    if Config.FlyEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local root = LocalPlayer.Character.HumanoidRootPart
        local moveDirection = LocalPlayer.Character.Humanoid.MoveDirection
        local flySpeed = Config.FlySpeed
        local vertical = UserInputService:IsKeyDown(Enum.KeyCode.Space) and flySpeed / 8 or UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) and -flySpeed / 8 or 0
        root.CFrame = root.CFrame + moveDirection * deltaTime * flySpeed * 10
        root.CFrame = root.CFrame + Vector3.new(0, vertical, 0)
        root.Velocity = root.Velocity * Vector3.new(1, 0, 1) + Vector3.new(0, 1.9, 0)
    end
end

local function GetClosestValidPlayer()
    local closest = nil
    local shortestDist = math.huge
    local mousePos = UserInputService:GetMouseLocation()

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = plr.Character.HumanoidRootPart
            local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
            if onScreen then
                local distFromMouse = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                if distFromMouse <= FOV_RADIUS and distFromMouse < shortestDist then
                    shortestDist = distFromMouse
                    closest = plr
                end
            end
        end
    end
    return closest
end

local function GetClosestValidPlayer()
    local closestPlayer = nil
    local shortestDistance = math.huge

    local myChar = LocalPlayer.Character
    local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
    if not myHRP then return nil end

    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and Config.SelectedPlayers[plr.Name] and isAlive(plr) and plr.Character then
            local targetPart = plr.Character:FindFirstChild(getgenv().Aimbot.Hitpart)
            local targetHRP = plr.Character:FindFirstChild("HumanoidRootPart")
            if targetPart and targetHRP then
                -- T√≠nh kho·∫£ng c√°ch 3D trong game
                local dist = (myHRP.Position - targetHRP.Position).Magnitude
                if dist < shortestDistance then
                    closestPlayer = plr
                    shortestDistance = dist
                end
            end
        end
    end

    return closestPlayer
end

local function IsObstructed(origin, targetPos)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {LocalPlayer.Character}
    local result = Workspace:Raycast(origin, (targetPos - origin), raycastParams)
    if result and result.Instance and not result.Instance:IsDescendantOf(Player and Player.Character) then
        return true
    end
    return false
end

local function validPart(p)
    if not p or not p.Parent or not p.Parent:FindFirstChild("Humanoid") then return false end
    local player = Players:GetPlayerFromCharacter(p.Parent)
    if not player or not Config.SelectedPlayers[player.Name] then return false end
    for _, n in ipairs(hitParts) do
        if p.Name:lower() == n:lower() then return true end
    end
    return false
end

local function distToCursor(part)
    local v, vis = Camera:WorldToViewportPoint(part.Position)
    if not vis then return math.huge end
    local m = UserInputService.TouchEnabled and Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2) or UserInputService:GetMouseLocation()
    return (Vector2.new(v.X, v.Y) - Vector2.new(m.X, m.Y)).Magnitude
end

local function click()
    if UserInputService.TouchEnabled then
        local touchPos = UserInputService:GetMouseLocation()
        VirtualInputManager:SendTouchEvent(0, Enum.UserInputState.Begin, touchPos)
        task.wait()
        VirtualInputManager:SendTouchEvent(0, Enum.UserInputState.End, touchPos)
    else
        if mouse1press then
            mouse1press()
            mouse1release()
        elseif mouse1click then
            mouse1click()
        end
    end
end

local function GetBestTargetPart()
    local bestPart, bestDist = nil, fovRadius
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and Config.SelectedPlayers[plr.Name] and isAlive(plr) and plr.Character then
            for _, partName in ipairs(hitParts) do
                local part = plr.Character:FindFirstChild(partName)
                if part and part:IsA("BasePart") then
                    local dist = distToCursor(part)
                    if dist < bestDist then
                        bestPart = part
                        bestDist = dist
                    end
                end
            end
        end
    end
    return bestPart
end

local function UpdateAimbot()
    if Config.AimbotEnabled and getgenv().Aimbot.Status then
        local Player = GetClosestValidPlayer()
        if Player and Player.Character and Player.Character:FindFirstChild(getgenv().Aimbot.Hitpart) then
            local part = Player.Character[getgenv().Aimbot.Hitpart]
            local ping = Config.AutoPredictionEnabled and GetPing() or (Config.CustomPing or GetPing())
            local predictedPos = CalculateVIPPrediction(part, ping)
            if predictedPos and not IsObstructed(Camera.CFrame.Position, predictedPos) then
                Camera.CFrame = CFrame.new(Camera.CFrame.Position, predictedPos)
            end
        end
    end
end

local function UpdateTriggerBot()
    if tbEnabled then
        local part = GetBestTargetPart()
        if part then
            task.spawn(function()
                local cap = part
                task.wait(0)
                if tbEnabled and distToCursor(cap) <= fovRadius then
                    local origin = Camera.CFrame.Position
                    local direction = (cap.Position - origin)
                    local rayParams = RaycastParams.new()
                    rayParams.FilterType = Enum.RaycastFilterType.Blacklist
                    rayParams.FilterDescendantsInstances = {LocalPlayer.Character}

                    local result = Workspace:Raycast(origin, direction, rayParams)

                    if not result or result.Instance:IsDescendantOf(cap.Parent) then
                        if UserInputService.TouchEnabled and not UserInputService.MouseEnabled then
                            local char = LocalPlayer.Character
                            local fired = false
                            if char then
                                for _, tool in ipairs(char:GetChildren()) do
                                    if tool:IsA("Tool") then
                                        pcall(function() tool:Activate() end)
                                        fired = true
                                        break
                                    end
                                end
                            end
                            if not fired then
                                click()
                            end
                        else
                            click()
                        end
                    end
                end
            end)
        end
    end
end

local function UpdateHitbox()
    if getgenv().HitboxStatus == "NoVisual" or getgenv().HitboxStatus == "Visual" then
        for _, player in ipairs(game:GetService('Players'):GetPlayers()) do
            if player.Name ~= game:GetService('Players').LocalPlayer.Name then
                if getgenv().TeamCheck and game:GetService('Players').LocalPlayer.Team == player.Team then
                    continue
                end
                if Config.OnlyTargetHitbox and not Config.SelectedPlayers[player.Name] then
                    continue
                end
                pcall(function()
                    player.Character.HumanoidRootPart.Size = Vector3.new(getgenv().HitboxSize, getgenv().HitboxSize, getgenv().HitboxSize)
                    player.Character.HumanoidRootPart.Transparency = getgenv().HitboxTransparency
                    player.Character.HumanoidRootPart.BrickColor = BrickColor.new("Really black")
                    player.Character.HumanoidRootPart.Material = "Neon"
                    player.Character.HumanoidRootPart.CanCollide = false
                end)
            end
        end
    else
        for _, player in ipairs(game:GetService('Players'):GetPlayers()) do
            if player.Name ~= game:GetService('Players').LocalPlayer.Name then
                pcall(function()
                    player.Character.HumanoidRootPart.Size = Vector3.new(2, 2, 1)
                    player.Character.HumanoidRootPart.Transparency = 1
                    player.Character.HumanoidRootPart.BrickColor = BrickColor.new("Medium stone grey")
                    player.Character.HumanoidRootPart.Material = "Plastic"
                    player.Character.HumanoidRootPart.CanCollide = false
                end
            end
        end
    end
end

local function Connect(event, callback)
    local connection = event:Connect(callback)
    table.insert(Connections, connection)
    return connection
end

--// GUI Setup
local chatWindow = TextChatService:FindFirstChild("ChatWindowConfiguration")
if chatWindow then
    chatWindow.Enabled = true -- B·∫≠t l·∫°i chat window
end

local gui = Instance.new("ScreenGui")
gui.Name = "DhuyxMenu"
gui.ResetOnSpawn = false
gui.Parent = game:GetService("CoreGui")
gui.DisplayOrder = 10000
gui.ZIndexBehavior = Enum.ZIndexBehavior.Global
gui.IgnoreGuiInset = true

-- T·∫°o Toggle Button
local ToggleButton = Instance.new("ImageButton")
ToggleButton.Size = UDim2.new(0, 45, 0, 45)
ToggleButton.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
ToggleButton.Image = "rbxassetid://80952463173309"
ToggleButton.ScaleType = Enum.ScaleType.Fit
ToggleButton.Parent = gui
Instance.new("UICorner", ToggleButton).CornerRadius = UDim.new(0, 10)
makeSmoothDraggable(ToggleButton, 0.18)

-- ƒê·∫∑t v·ªã tr√≠ d·ª±a tr√™n thi·∫øt b·ªã
if isTouchDevice() then
    ToggleButton.Position = UDim2.new(0, 15, 0, 250) -- Gi·ªØ nguy√™n cho ƒëi·ªán tho·∫°i
else
    ToggleButton.Position = UDim2.new(0, 770, 0, 715) -- V·ªã tr√≠ cho PC
end

--// MainFrame
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 400, 0, 300)
MainFrame.Position = UDim2.new(0.08, 0, 0.2, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
MainFrame.Visible = true
MainFrame.Parent = gui
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 12)
makeSmoothDraggable(MainFrame, 0.2)

-- Shadow
local shadow = Instance.new("ImageLabel", MainFrame)
shadow.Size = UDim2.new(1, 30, 1, 30)
shadow.Position = UDim2.new(0, -15, 0, -15)
shadow.Image = "rbxassetid://1316045217"
shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
shadow.ImageTransparency = 0.4
shadow.ScaleType = Enum.ScaleType.Slice
shadow.SliceCenter = Rect.new(10, 10, 118, 118)
shadow.ZIndex = -1
shadow.BackgroundTransparency = 1

-- Title
local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(1, -10, 0, 35)
Title.Position = UDim2.new(0, 5, 0, 5)
Title.Text = "Xinloinguoiyeu"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.BackgroundTransparency = 1

-- Ping/FPS/Clock
local PingClock = Instance.new("TextLabel")
PingClock.Size = UDim2.new(0, 200, 0, 25)
PingClock.Position = UDim2.new(0, 5, 0, 35)
PingClock.BackgroundTransparency = 1
PingClock.TextColor3 = Color3.fromRGB(200, 200, 200)
PingClock.Font = Enum.Font.Gotham
PingClock.TextSize = 12
PingClock.Parent = MainFrame

task.spawn(function()
    while task.wait(0.5) do
        local ping =  math.floor(game:GetService("Stats").Network.ServerStatsItem["Data Ping"]:GetValue())
        local fps = math.clamp(math.floor(1 / (lastDt > 0 and lastDt or 1/240)), 1, 999)
        local timeStr = os.date("%H:%M")
        PingClock.Text = string.format("Ping: %d ms | FPS: %d | %s", ping, fps, timeStr)
    end
end)

--// Tabs
local TabHolder = Instance.new("Frame", MainFrame)
TabHolder.Size = UDim2.new(1, -10, 0, 30)
TabHolder.Position = UDim2.new(0, 5, 0, 65)
TabHolder.BackgroundTransparency = 1
local TabLayout = Instance.new("UIListLayout", TabHolder)
TabLayout.FillDirection = Enum.FillDirection.Horizontal
TabLayout.Padding = UDim.new(0, 5)

local Tab1Btn = createTab("Da Hood", TabHolder)
local Tab2Btn = createTab("Universal", TabHolder)
local Tab3Btn = createTab("Scripts", TabHolder)
local Tab5Btn = createTab("Info", TabHolder)

--// Pages
local Pages = Instance.new("Frame", MainFrame)
Pages.Size = UDim2.new(1, -10, 1, -105)
Pages.Position = UDim2.new(0, 5, 0, 100)
Pages.BackgroundTransparency = 1
Pages.ClipsDescendants = true

local Page1 = Instance.new("Frame", Pages) -- Da Hood
Page1.Size = UDim2.new(1, 0, 1, 0)
Page1.BackgroundTransparency = 1

local Page2 = Instance.new("Frame", Pages) -- Universal
Page2.Size = UDim2.new(1, 0, 1, 0)
Page2.BackgroundTransparency = 1
Page2.Visible = false

local Page3 = Instance.new("Frame", Pages) -- Scripts
Page3.Size = UDim2.new(1, 0, 1, 0)
Page3.BackgroundTransparency = 1
Page3.Visible = false

local Page5 = Instance.new("Frame", Pages) -- Info
Page5.Size = UDim2.new(1, 0, 1, 0)
Page5.BackgroundTransparency = 1
Page5.Visible = false

Tab1Btn.MouseButton1Click:Connect(function() switchPage(Page1, {Page1, Page2, Page3, Page5}) end)
Tab2Btn.MouseButton1Click:Connect(function() switchPage(Page2, {Page1, Page2, Page3, Page5}) end)
Tab3Btn.MouseButton1Click:Connect(function() switchPage(Page3, {Page1, Page2, Page3, Page5}) end)
Tab5Btn.MouseButton1Click:Connect(function() switchPage(Page5, {Page1, Page2, Page3, Page5}) end)

--// Page 1 (Da Hood)
local ButtonFrame1 = Instance.new("ScrollingFrame", Page1)
ButtonFrame1.Size = UDim2.new(0.5, -5, 1, -20)
ButtonFrame1.Position = UDim2.new(0, 5, 0, 10)
ButtonFrame1.BackgroundTransparency = 1
ButtonFrame1.ScrollBarThickness = 4
ButtonFrame1.CanvasSize = UDim2.new(0, 0, 0, 0)

local ButtonLayout1 = Instance.new("UIListLayout", ButtonFrame1)
ButtonLayout1.SortOrder = Enum.SortOrder.LayoutOrder
ButtonLayout1.Padding = UDim.new(0, 6)
ButtonLayout1:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ButtonFrame1.CanvasSize = UDim2.new(0, 0, 0, ButtonLayout1.AbsoluteContentSize.Y)
end)

local PlayerListFrame = Instance.new("ScrollingFrame", Page1)
PlayerListFrame.Size = UDim2.new(0.5, -5, 1, -20)
PlayerListFrame.Position = UDim2.new(0.5, 0, 0, 10)
PlayerListFrame.BackgroundTransparency = 1
PlayerListFrame.ScrollBarThickness = 4
PlayerListFrame.CanvasSize = UDim2.new(0, 0, 0, 0)

local UIListLayout = Instance.new("UIListLayout", PlayerListFrame)
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 4)
UIListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    PlayerListFrame.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y)
end)

-- G·ªçi ban ƒë·∫ßu v√† khi player add/remove
UpdatePlayerList(PlayerListFrame)
Players.PlayerAdded:Connect(function() UpdatePlayerList(PlayerListFrame) end)
Players.PlayerRemoving:Connect(function() UpdatePlayerList(PlayerListFrame) end)

--// Page 2 (Universal)
local ButtonFrame2Left = Instance.new("ScrollingFrame", Page2)
ButtonFrame2Left.Size = UDim2.new(0.5, -5, 1, -20)
ButtonFrame2Left.Position = UDim2.new(0, 5, 0, 10)
ButtonFrame2Left.BackgroundTransparency = 1
ButtonFrame2Left.ScrollBarThickness = 4
ButtonFrame2Left.CanvasSize = UDim2.new(0, 0, 0, 0)

local ButtonLayout2Left = Instance.new("UIListLayout", ButtonFrame2Left)
ButtonLayout2Left.SortOrder = Enum.SortOrder.LayoutOrder
ButtonLayout2Left.Padding = UDim.new(0, 6)
ButtonLayout2Left:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ButtonFrame2Left.CanvasSize = UDim2.new(0, 0, 0, ButtonLayout2Left.AbsoluteContentSize.Y)
end)

local ButtonFrame2Right = Instance.new("ScrollingFrame", Page2)
ButtonFrame2Right.Size = UDim2.new(0.5, -5, 1, -20)
ButtonFrame2Right.Position = UDim2.new(0.5, 0, 0, 10)
ButtonFrame2Right.BackgroundTransparency = 1
ButtonFrame2Right.ScrollBarThickness = 4
ButtonFrame2Right.CanvasSize = UDim2.new(0, 0, 0, 0)

local ButtonLayout2Right = Instance.new("UIListLayout", ButtonFrame2Right)
ButtonLayout2Right.SortOrder = Enum.SortOrder.LayoutOrder
ButtonLayout2Right.Padding = UDim.new(0, 6)
ButtonLayout2Right:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ButtonFrame2Right.CanvasSize = UDim2.new(0, 0, 0, ButtonLayout2Right.AbsoluteContentSize.Y)
end)

--// Page 3 (Scripts)
local ScriptHubScroll = Instance.new("ScrollingFrame", Page3)
ScriptHubScroll.Size = UDim2.new(1, -10, 1, -30) -- Extended height for more space
ScriptHubScroll.Position = UDim2.new(0, 5, 0, 5)
ScriptHubScroll.BackgroundTransparency = 1
ScriptHubScroll.ScrollBarThickness = 6
ScriptHubScroll.ScrollingDirection = Enum.ScrollingDirection.Y
ScriptHubScroll.CanvasSize = UDim2.new(0, 0, 0, 0)

local ScriptListLayout = Instance.new("UIListLayout", ScriptHubScroll)
ScriptListLayout.SortOrder = Enum.SortOrder.LayoutOrder
ScriptListLayout.Padding = UDim.new(0, 6)
ScriptListLayout.FillDirection = Enum.FillDirection.Vertical
ScriptListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ScriptHubScroll.CanvasSize = UDim2.new(0, 0, 0, ScriptListLayout.AbsoluteContentSize.Y)
end)

CreateScriptItem("Evade", "https://raw.githubusercontent.com/quiwti08/Hackvip999/refs/heads/main/evade", ScriptHubScroll)
CreateScriptItem("Murder Mystery 2", "https://raw.githubusercontent.com/quiwti08/Hackvip999/refs/heads/main/rayfield", ScriptHubScroll)
CreateScriptItem("Blade Ball", "https://raw.githubusercontent.com/dadada-rgb/VhuyHub/refs/heads/main/Bladeball", ScriptHubScroll)
CreateScriptItem("Doors", "https://raw.githubusercontent.com/DarkDoorsKing/Project/main/Doors.lua", ScriptHubScroll)
CreateScriptItem("free all animation", "https://yarhm.mhi.im/scr?channel=afemmax", ScriptHubScroll)
CreateScriptItem("Infinite Yield", "https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source", ScriptHubScroll)
CreateScriptItem("Dex", "https://raw.githubusercontent.com/infyiff/backup/main/dex.lua", ScriptHubScroll)
CreateScriptItem("Hypershot", "https://api.luarmor.net/files/v3/loaders/c9f7b2cda8460f26a85bc14a419b3513.lua", ScriptHubScroll)
CreateScriptItem("simpleaim", "https://raw.githubusercontent.com/quiwti08/Hackvip999/refs/heads/main/simpleaimlockvip", ScriptHubScroll)
CreateScriptItem("The mimic", "https://raw.githubusercontent.com/Laelmano24/Rael-Hub/main/main.txt", ScriptHubScroll)
CreateScriptItem("Nigga.lol", "https://raw.githubusercontent.com/quiwti08/Hackvip999/refs/heads/main/niggalol", ScriptHubScroll)

--// Page 5 (Info)
local Avatar = Instance.new("ImageLabel", Page5)
Avatar.Size = UDim2.new(0, 80, 0, 80)
Avatar.Position = UDim2.new(0, 10, 0, 10)
Avatar.BackgroundTransparency = 1
Avatar.Image = "rbxthumb://type=AvatarHeadShot&id="..LocalPlayer.UserId.."&w=150&h=150"

local InfoPanel = Instance.new("Frame", Page5)
InfoPanel.Position = UDim2.new(0, 100, 0, 10)
InfoPanel.Size = UDim2.new(1, -110, 1, -20)
InfoPanel.BackgroundTransparency = 1
InfoPanel.ClipsDescendants = true

local InfoLayout = Instance.new("UIListLayout", InfoPanel)
InfoLayout.Padding = UDim.new(0, 6)
InfoLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
InfoLayout.VerticalAlignment = Enum.VerticalAlignment.Top

local lineDisplay = mkLine(InfoPanel)
local lineUser = mkLine(InfoPanel)
local lineFPS = mkLine(InfoPanel)
local lineTime = mkLine(InfoPanel)
local lineCountry = mkLine(InfoPanel)
local lineFriends = mkLine(InfoPanel)

lineDisplay.Text = "Display Name : "..LocalPlayer.DisplayName
lineUser.Text = "Username     : @"..LocalPlayer.Name

task.spawn(function()
    local c = "Unknown"
    pcall(function()
        c = LocalizationService:GetCountryRegionForPlayerAsync(LocalPlayer) or "Unknown"
    end)
    lineCountry.Text = "Country      : "..c
end)

task.spawn(function()
    local ok, list = pcall(function() return Players:GetFriendsOnline() end)
    local count = (ok and type(list)=="table") and #list or 0
    lineFriends.Text = "Friends Online: "..count
end)

task.spawn(function()
    while task.wait(0.5) do
        local fps = math.clamp(math.floor(1 / (lastDt > 0 and lastDt or 1/240)), 1, 999)
        lineFPS.Text = "FPS          : "..fps
        lineTime.Text = "Time         : "..os.date("%H:%M")
    end
end)

--// Toggle open/close
ToggleButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

--// Keybinds
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    local key = input.KeyCode.Name:upper()
    if Keybinds[key] then
        Keybinds[key]()
    end
end)

-- T·∫°o hi·ªáu ·ª©ng m·ªù n·ªÅn
local blur = Instance.new("BlurEffect")
blur.Size = 20
blur.Parent = Lighting

-- T·∫°o GUI intro
local introGui = Instance.new("ScreenGui")
introGui.Name = "VhuyIntroGui"
introGui.IgnoreGuiInset = true
introGui.ResetOnSpawn = false
introGui.DisplayOrder = 99999
introGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local bg = Instance.new("Frame")
bg.Size = UDim2.new(1, 0, 1, 0)
bg.BackgroundColor3 = Color3.new(0, 0, 0)
bg.BackgroundTransparency = 1
bg.Parent = introGui

local title = Instance.new("TextLabel")
title.AnchorPoint = Vector2.new(0.5, 0.5)
title.Position = UDim2.new(0.5, 0, 0.5, 0)
title.Size = UDim2.new(0, 400, 0, 120)
title.Text = "DhuyxDtuyen"
title.Font = Enum.Font.GothamBlack
title.TextColor3 = Color3.fromRGB(55, 55, 55)
title.TextScaled = true
title.TextTransparency = 1
title.BackgroundTransparency = 1
title.Parent = introGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 12)
corner.Parent = title

local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(55, 55, 55)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(230, 230, 230))
}
gradient.Rotation = 45
gradient.Parent = title

-- Hi·ªáu ·ª©ng fade in
TweenService:Create(title, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.In), {TextTransparency = 0}):Play()
TweenService:Create(bg, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.In), {BackgroundTransparency = 0.4}):Play()

-- Hi·ªáu ·ª©ng fade out
task.delay(4, function()
    TweenService:Create(title, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {TextTransparency = 1}):Play()
    TweenService:Create(bg, TweenInfo.new(1.5, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {BackgroundTransparency = 1}):Play()
    task.delay(1.5, function()
        introGui:Destroy()
        blur:Destroy()
    end)
end)

aimbotButton = CreateButton(ButtonFrame1, "Aimlock: OFF", function()
    Config.AimbotEnabled = not Config.AimbotEnabled
    aimbotButton.Text = "Aimlock: " .. (Config.AimbotEnabled and "ON" or "OFF")
    sendNotification("AIMLOCK", Config.AimbotEnabled and "ON" or "OFF")
end)

-- √î nh·∫≠p Ping (b·ªè qua khi AutoPrediction b·∫≠t)
predictionBox = Instance.new("TextBox")
predictionBox.Size = UDim2.new(1, -10, 0, 25)
predictionBox.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
predictionBox.BackgroundTransparency = 0.2
predictionBox.TextColor3 = Color3.fromRGB(0, 0, 0)
predictionBox.TextSize = 14
predictionBox.Font = Enum.Font.Gotham
predictionBox.PlaceholderText = "Nh·∫≠p Ping"
predictionBox.Text = tostring(Config.CustomPing or 40)
predictionBox.ClearTextOnFocus = false
predictionBox.Parent = ButtonFrame1
Instance.new("UICorner", predictionBox).CornerRadius = UDim.new(0, 6)

predictionBox:GetPropertyChangedSignal("Text"):Connect(function()
    if Config.AutoPredictionEnabled then return end 
    local num = tonumber(predictionBox.Text)
    if num then
        Config.CustomPing = math.clamp(num, 0, 1000)
    else
        Config.CustomPing = 40
        predictionBox.Text = "40"
    end
end)

task.spawn(function()
    while task.wait(0.2) do
        local ping = GetPing()
        if Config.AutoPredictionEnabled then
            Config.Prediction = CalculateVIPPrediction(ping)
        else
            local cp = Config.CustomPing or ping
            Config.Prediction = CalculateVIPPrediction(cp)
        end
    end
end)

autoPredictionButton = CreateButton(ButtonFrame1, "Auto Prediction: OFF", function()
    Config.AutoPredictionEnabled = not Config.AutoPredictionEnabled
    autoPredictionButton.Text = "Auto Prediction: " .. (Config.AutoPredictionEnabled and "ON" or "OFF")
    sendNotification("Auto Prediction", Config.AutoPredictionEnabled and "ON" or "OFF")
end)

hitpartButton = CreateButton(ButtonFrame1, "Hitpart: Head", function()
    hitpartIndex = (hitpartIndex % #hitpartOptions) + 1
    getgenv().Aimbot.Hitpart = hitpartOptions[hitpartIndex]
    hitpartButton.Text = "Hitpart: " .. getgenv().Aimbot.Hitpart
    sendNotification("Aimlock", "Hitpart changed to " .. getgenv().Aimbot.Hitpart)
end)

espButton = CreateButton(ButtonFrame1, "ESP: OFF", function()
    Config.ESPEnabled = not Config.ESPEnabled
    espButton.Text = "ESP: " .. (Config.ESPEnabled and "ON" or "OFF")
    sendNotification("ESP", Config.ESPEnabled and "ON" or "OFF")
end)

noSlowButton = CreateButton(ButtonFrame1, "No Slowdown: OFF", function()
    Config.NoSlowdownEnabled = not Config.NoSlowdownEnabled
    noSlowButton.Text = "No Slowdown: " .. (Config.NoSlowdownEnabled and "ON" or "OFF")
    sendNotification("No Slowdown", Config.NoSlowdownEnabled and "ON" or "OFF")
end)

speedButton = CreateButton(ButtonFrame1, "Speed: OFF", function()
    Config.SpeedEnabled = not Config.SpeedEnabled
    speedButton.Text = "Speed: " .. (Config.SpeedEnabled and "ON" or "OFF")
    sendNotification("SPEED", Config.SpeedEnabled and "ON" or "OFF")
end)

flyButton = CreateButton(ButtonFrame1, "Fly: OFF", function()
    Config.FlyEnabled = not Config.FlyEnabled
    flyButton.Text = "Fly: " .. (Config.FlyEnabled and "ON" or "OFF")
    sendNotification("FLY", Config.FlyEnabled and "ON" or "OFF")
end)

boostJumpButton = CreateButton(ButtonFrame1, "Boost Jump: OFF", function()
    AscendEnabled = not AscendEnabled
    boostJumpButton.Text = "Boost Jump: " .. (AscendEnabled and "ON" or "OFF")
    sendNotification("Boost Jump", AscendEnabled and "ON" or "OFF")
end)

antiLockButton = CreateButton(ButtonFrame1, "AntiLock: OFF", function()
    -- tƒÉng mode
    modeIndex = modeIndex + 1
    if modeIndex > #antiLockModes then
        modeIndex = 1
    end

    local mode = antiLockModes[modeIndex]
    if mode == "OFF" then
        Config.AntiLockEnabled = false
    else
        Config.AntiLockEnabled = true
        Config.AntiLockType = mode
    end

    antiLockButton.Text = "AntiLock: " .. mode
    sendNotification("AntiLock", "Mode: " .. mode)
end)

triggerBotButton = CreateButton(ButtonFrame1, "TriggerBot: " .. (tbEnabled and "ON" or "OFF"), function()
    tbEnabled = not tbEnabled
    triggerBotButton.Text = "TriggerBot: " .. (tbEnabled and "ON" or "OFF")
    sendNotification("TRIGGERBOT", tbEnabled and "ON" or "OFF")
end)

csyncRandomButton = CreateButton(ButtonFrame1, "Csync Random: " .. (Config.CsyncRandomEnabled and "ON" or "OFF"), function()
    Config.CsyncRandomEnabled = not Config.CsyncRandomEnabled
    csyncRandomButton.Text = "Csync Random: " .. (Config.CsyncRandomEnabled and "ON" or "OFF")
    sendNotification("Csync Random", Config.CsyncRandomEnabled and "Enabled" or "Disabled")
end)

csyncOrbitButton = CreateButton(ButtonFrame1, "Csync Orbit: " .. (Config.CsyncOrbitEnabled and "ON" or "OFF"), function()
    Config.CsyncOrbitEnabled = not Config.CsyncOrbitEnabled
    csyncOrbitButton.Text = "Csync Orbit: " .. (Config.CsyncOrbitEnabled and "ON" or "OFF")
    sendNotification("Csync Orbit", Config.CsyncOrbitEnabled and "Enabled" or "Disabled")
end)

-- Frame nh·∫≠p Radius, Height, Speed
local boxFrame = Instance.new("Frame")
boxFrame.Size = UDim2.new(1, 0, 0, 40)
boxFrame.BackgroundTransparency = 1
boxFrame.Parent = ButtonFrame1

createLabeledBox(boxFrame, "Radius", Config.CsyncRadius, function(v) Config.CsyncRadius = v end, UDim2.new(0, 0, 0, 0))
createLabeledBox(boxFrame, "Height", Config.CsyncHeight, function(v) Config.CsyncHeight = v end, UDim2.new(1/3, 0, 0, 0))
createLabeledBox(boxFrame, "Speed",  Config.CsyncSpeed,  function(v) Config.CsyncSpeed  = v end, UDim2.new(2/3, 0, 0, 0))

fovButton = CreateButton(ButtonFrame2Left, "Custom FOV: " .. (Config.CustomFOVEnabled and "ON" or "OFF"), function()
    Config.CustomFOVEnabled = not Config.CustomFOVEnabled
    fovButton.Text = "Custom FOV: " .. (Config.CustomFOVEnabled and "ON" or "OFF")
    sendNotification("Custom FOV", Config.CustomFOVEnabled and "Enabled (FOV: " .. Config.CustomFOV .. ")" or "Disabled")
    applyFOV()
end)

-- T·∫°o √¥ nh·∫≠p FOV
local fovBox = Instance.new("TextBox")
fovBox.Size = UDim2.new(1, -10, 0, 25)
fovBox.Position = UDim2.new(0, 0, 0, 40) -- ƒêi·ªÅu ch·ªânh v·ªã tr√≠ theo GUI c·ªßa b·∫°n
fovBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
fovBox.TextColor3 = Color3.new(1, 1, 1)
fovBox.Text = tostring(Config.CustomFOV)
fovBox.PlaceholderText = "FOV (40-120)"
fovBox.ClearTextOnFocus = false
fovBox.Font = Enum.Font.GothamBold
fovBox.TextSize = 12
fovBox.Parent = ButtonFrame2Left
Instance.new("UICorner", fovBox).CornerRadius = UDim.new(0, 4)

-- X·ª≠ l√Ω khi ng∆∞·ªùi d√πng nh·∫≠p FOV
fovBox:GetPropertyChangedSignal("Text"):Connect(function()
    local num = tonumber(fovBox.Text)
    if num then
        -- Gi·ªõi h·∫°n gi√° tr·ªã trong kho·∫£ng 40-120
        Config.CustomFOV = math.clamp(num, 40, 120)
        fovBox.Text = tostring(Config.CustomFOV) -- C·∫≠p nh·∫≠t √¥ nh·∫≠p
        if Config.CustomFOVEnabled then
            applyFOV()
            sendNotification("Custom FOV", "ƒê√£ ƒë·∫∑t FOV th√†nh " .. Config.CustomFOV)
        end
    else
        fovBox.Text = tostring(Config.CustomFOV) -- Kh√¥i ph·ª•c gi√° tr·ªã h·ª£p l·ªá
    end
end)

onlyTargetHitboxButton = CreateButton(ButtonFrame2Left, "OnlyTargetHitbox: OFF", function()
    Config.OnlyTargetHitbox = not Config.OnlyTargetHitbox
    onlyTargetHitboxButton.Text = "OnlyTargetHitbox: " .. (Config.OnlyTargetHitbox and "ON" or "OFF")
    sendNotification("OnlyTargetHitbox", Config.OnlyTargetHitbox and "ON" or "OFF")
end)

hitboxButton = CreateButton(ButtonFrame2Left, "Hitbox: OFF", function()
    if getgenv().HitboxStatus == "OFF" then
        getgenv().HitboxStatus = "NoVisual"
        getgenv().HitboxTransparency = 1  -- Kh√¥ng th·∫•y hitbox
    elseif getgenv().HitboxStatus == "NoVisual" then
        getgenv().HitboxStatus = "Visual"
        getgenv().HitboxTransparency = 0.9  -- Th·∫•y hitbox
    else
        getgenv().HitboxStatus = "OFF"
        getgenv().HitboxTransparency = 1  -- Reset
    end
    hitboxButton.Text = "Hitbox: " .. getgenv().HitboxStatus
    if typeof(sendNotification) == "function" then
        sendNotification("Hitbox", getgenv().HitboxStatus)
    else
        print("Hitbox: " .. getgenv().HitboxStatus)
    end
end)

-- √î nh·∫≠p gi√° tr·ªã Hitbox Size (m·∫∑c ƒë·ªãnh 15)
local hitboxBox = Instance.new("TextBox")
hitboxBox.Size = UDim2.new(1, -10, 0, 25)
hitboxBox.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
hitboxBox.BackgroundTransparency = 0.2
hitboxBox.TextColor3 = Color3.fromRGB(0, 0, 0)
hitboxBox.TextSize = 14
hitboxBox.Font = Enum.Font.Gotham
hitboxBox.Text = tostring(getgenv().HitboxSize or 15) -- m·∫∑c ƒë·ªãnh gi√° tr·ªã 15
hitboxBox.PlaceholderText = "Nh·∫≠p Hitbox Size"
hitboxBox.ClearTextOnFocus = false
hitboxBox.Parent = ButtonFrame2Left
Instance.new("UICorner", hitboxBox).CornerRadius = UDim.new(0, 6)

-- N·∫øu ng∆∞·ªùi d√πng nh·∫≠p gi√° tr·ªã h·ª£p l·ªá th√¨ c·∫≠p nh·∫≠t
hitboxBox:GetPropertyChangedSignal("Text"):Connect(function()
    local num = tonumber(hitboxBox.Text)
    if num and num > 0 then
        getgenv().HitboxSize = num
        sendNotification("Hitbox", "Size = "..num)
    end
end)

angelWingButton = CreateButton(ButtonFrame2Left, "Angel Wing: OFF", function()
    AngelWingEnabled = not AngelWingEnabled
    angelWingButton.Text = "Angel Wing: " .. (AngelWingEnabled and "ON" or "OFF")
    sendNotification("Angel Wing", AngelWingEnabled and "ON" or "OFF")
    if AngelWingEnabled then
        createAw()
    else
        destroyAw()
    end
end)

hugButton = CreateButton(ButtonFrame2Left, "HugR6: OFF", function()
    hugEnabled = not hugEnabled
    hugButton.Text = "HugR6: " .. (hugEnabled and "ON" or "OFF")

    local player = game.Players.LocalPlayer
    local char = player.Character or player.CharacterAdded:Wait()
    local hum = char:WaitForChild("Humanoid")

    -- N·∫øu b·∫≠t th√¨ t·∫°o anim v√† play
    if hugEnabled then
        if hum.RigType == Enum.HumanoidRigType.R6 then
            local Anim_1 = Instance.new("Animation")
            Anim_1.AnimationId = "rbxassetid://283545583"
            Play_1 = hum:LoadAnimation(Anim_1)

            local Anim_2 = Instance.new("Animation")
            Anim_2.AnimationId = "rbxassetid://225975820"
            Play_2 = hum:LoadAnimation(Anim_2)
        else
            local Anim_R15 = Instance.new("Animation")
            Anim_R15.AnimationId = "rbxassetid://118478639008343"
            Play_1 = hum:LoadAnimation(Anim_R15)
        end

        if Play_1 then Play_1:Play() end
        if Play_2 then Play_2:Play() end
    else
        stopAnim()
    end
end)

piggyButton = CreateButton(ButtonFrame2Left, "Piggyback: OFF", function()
    piggyEnabled = not piggyEnabled
    if not piggyEnabled then
        stopPiggy()
        sendNotification("Piggyback", "OFF")
        return
    end

    local target = getClosestSelected()
    if not target then
        stopPiggy()
        return
    end

    startPiggy(target)
end)

fullbrightButton = CreateButton(ButtonFrame2Left, "Fullbright: OFF", function()
    Config.FullbrightEnabled = not Config.FullbrightEnabled
    if Config.FullbrightEnabled then
        Lighting.Brightness = 2
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 999999
        Lighting.Ambient = Color3.fromRGB(255, 255, 255)
        Lighting.OutdoorAmbient = Color3.fromRGB(255, 255, 255)
        Lighting.ClockTime = 12
    else
        Lighting.Brightness = oldLighting.Brightness
        Lighting.GlobalShadows = oldLighting.GlobalShadows
        Lighting.FogEnd = oldLighting.FogEnd
        Lighting.Ambient = oldLighting.Ambient
        Lighting.OutdoorAmbient = oldLighting.OutdoorAmbient
        Lighting.ClockTime = oldLighting.ClockTime
    end
    fullbrightButton.Text = "Fullbright: " .. (Config.FullbrightEnabled and "ON" or "OFF")
    sendNotification("FULLBRIGHT", Config.FullbrightEnabled and "ON" or "OFF")
end)

autoWallhopButton = CreateButton(ButtonFrame2Left, "Auto Wallhop: " .. (Config.AutoWallhopEnabled and "ON" or "OFF"), function()
    Config.AutoWallhopEnabled = not Config.AutoWallhopEnabled
    autoWallhopButton.Text = "Auto Wallhop: " .. (Config.AutoWallhopEnabled and "ON" or "OFF")
    sendNotification("Auto Wallhop", Config.AutoWallhopEnabled and "Enabled" or "Disabled")
end)

rainbowHitButton = CreateButton(ButtonFrame2Left, "Aura Hit Effect: " .. (Config.RainbowHitEffectEnabled and "ON" or "OFF"), function()
    Config.RainbowHitEffectEnabled = not Config.RainbowHitEffectEnabled
    rainbowHitButton.Text = "Aura Hit Effect: " .. (Config.RainbowHitEffectEnabled and "ON" or "OFF")
    sendNotification("Aura Hit Effect", Config.RainbowHitEffectEnabled and "Enabled" or "Disabled")
end)

antiAfkButton = CreateButton(ButtonFrame2Left, "Anti AFK: OFF", function()
    antiAfkEnabled = not antiAfkEnabled
    antiAfkButton.Text = "Anti AFK: " .. (antiAfkEnabled and "ON" or "OFF")
    sendNotification("ANTI AFK", antiAfkEnabled and "ON" or "OFF")

    if antiAfkEnabled then
        -- V√≤ng l·∫∑p t·ª± nh·∫£y m·ªói 60 gi√¢y
        antiAfkLoop = task.spawn(function()
            while antiAfkEnabled do
                task.wait(60) -- ƒê·ª£i 60 gi√¢y
                pcall(function()
                    local hum = game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                    if hum then
                        hum:ChangeState(Enum.HumanoidStateType.Jumping)
                    end
                end)
            end
        end)
    else
        if antiAfkLoop then
            task.cancel(antiAfkLoop)
            antiAfkLoop = nil
        end
    end
end)

bangButton = CreateButton(ButtonFrame2Left, "BangPlayer: OFF", function()
    animEnabled = not animEnabled
    
    if not animEnabled then
        stopAnimAndTp()
        bangButton.Text = "BangPlayer: OFF"
        sendNotification("BangPlayer", "ƒê√£ t·∫Øt")
    else
        local target = getClosestSelected()
        if not target then
            animEnabled = false
            bangButton.Text = "BangPlayer: OFF"
            return
        end

        local myChar = LocalPlayer.Character
        local myHum = myChar and myChar:FindFirstChildOfClass("Humanoid")
        local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
        if not (myHum and myHRP) then
            animEnabled = false
            bangButton.Text = "BangPlayer: OFF"
            sendNotification("BangPlayer", "Kh√¥ng t√¨m th·∫•y nh√¢n v·∫≠t!")
            return
        end

        -- Ch·ªçn animation theo rig type
        local anim = Instance.new("Animation")
        anim.AnimationId = myHum.RigType == Enum.HumanoidRigType.R6 and "rbxassetid://148840371" or "rbxassetid://96387457087289"

        -- Ph√°t animation
        animTrack = myHum:LoadAnimation(anim)
        animTrack:Play()
        animTrack:AdjustSpeed(10)

        bangButton.Text = "BangPlayer: ON (" .. target.Name .. ")"
        sendNotification("BangPlayer", "ƒêang d√≠nh theo " .. target.Name)

        -- Teleport li√™n t·ª•c
        bangConnection = RunService.Heartbeat:Connect(function()
            if animEnabled and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                myHRP.CFrame = target.Character.HumanoidRootPart.CFrame * CFrame.new(0, 0, 1)
            else
                stopAnimAndTp()
                bangButton.Text = "BangPlayer: OFF"
            end
        end)
    end
end)

tpAndStompButton = CreateButton(ButtonFrame2Left, "TP Player", function()
    local myPos = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position
    if not myPos then return end

    local closestPlayer, minDist = nil, math.huge

    for name, selected in pairs(Config.SelectedPlayers) do
        if selected then
            local plr = Players:FindFirstChild(name)
            if plr and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                local pos = plr.Character.HumanoidRootPart.Position
                local dist = (myPos - pos).Magnitude
                if dist < minDist then
                    closestPlayer = plr
                    minDist = dist
                end
            end
        end
    end

    if closestPlayer then
        local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if root then
            local pos = closestPlayer.Character.HumanoidRootPart.Position
            root.CFrame = CFrame.new(pos + Vector3.new(0, 0, 0))
        end
    end
end)

invisibleButton = CreateButton(ButtonFrame2Left, "Invisible: " .. (IsInvis and "ON" or "OFF"), function()
    if not IsInvis then
        ToggleInvisible() -- B·∫≠t invis
    else
        TurnVisible()     -- T·∫Øt invis
        IsInvis = false
    end
    
    -- C·∫≠p nh·∫≠t n√∫t v√† notify
    invisibleButton.Text = "Invisible: " .. (IsInvis and "ON" or "OFF")
    sendNotification("Invisible", IsInvis and "ON" or "OFF")
end)

noclipButton = CreateButton(ButtonFrame2Left, "Noclip: OFF", function()
    Config.NoclipEnabled = not Config.NoclipEnabled
    
    if Config.NoclipEnabled then
        if noclipConnection then noclipConnection:Disconnect() end
        noclipConnection = RunService.Stepped:Connect(function()
            local char = LocalPlayer.Character
            if char and char:FindFirstChildOfClass("Humanoid") then
                for _, part in ipairs(char:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
            end
        end)
    else
        if noclipConnection then
            noclipConnection:Disconnect()
            noclipConnection = nil
        end
    end

   sendNotification("NOCLIP", Config.NoclipEnabled and "ON" or "OFF")
    noclipButton.Text = "Noclip: " .. (Config.NoclipEnabled and "ON" or "OFF")
end)

CreateButton(ButtonFrame2Right, "Happier Jump", function()
    playAnimation(animations.happier)
end)

CreateButton(ButtonFrame2Right, "Happy", function()
    playAnimation(animations.happy)
end)

CreateButton(ButtonFrame2Right, "siuu", function()
    playAnimation(animations.siuu)
end)

CreateButton(ButtonFrame2Right, "sturdy", function()
    playAnimation(animations.sturdy)
end)

CreateButton(ButtonFrame2Right, "cutesit", function()
    playAnimation(animations.cutesit)
end)

CreateButton(ButtonFrame2Right, "matching1", function()
    playAnimation(animations.matching1)
end)

CreateButton(ButtonFrame2Right, "matching2", function()
    playAnimation(animations.matching2)
end)

CreateButton(ButtonFrame2Right, "hug1", function()
    playAnimation(animations.hug1)
end)

CreateButton(ButtonFrame2Right, "hug2", function()
    playAnimation(animations.hug2)
end)

CreateButton(ButtonFrame2Right, "sit1", function()
    playAnimation(animations.sit1)
end)

CreateButton(ButtonFrame2Right, "sit2", function()
    playAnimation(animations.sit2)
end)

loopBringButton = CreateButton(ButtonFrame2Right, "Loop Bring: OFF", function()
    loopBring = not loopBring
    loopBringButton.Text = "Loop Bring: " .. (loopBring and "ON" or "OFF")

    if loopBring then
        loopBringConn = RunService.Heartbeat:Connect(function()
            local myHRP = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if not myHRP then return end

            for name, selected in pairs(Config.SelectedPlayers) do
                if selected then
                    local target = Players:FindFirstChild(name)
                    if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                        local hrp = target.Character.HumanoidRootPart
                        hrp.CFrame = myHRP.CFrame * CFrame.new(0, 0, -3)
                    end
                end
            end
        end)
    else
        if loopBringConn then
            loopBringConn:Disconnect()
            loopBringConn = nil
        end
    end
end)

clickTpButton = CreateButton(ButtonFrame2Right, "Click TP: OFF", function()
    Config.clickTpEnabled = not Config.clickTpEnabled
    sendNotification("GIVECLICKTOOL", Config.clickTpEnabled and "ON" or "OFF")
    clickTpButton.Text = "Click TP: " .. (Config.clickTpEnabled and "ON" or "OFF")
    if Config.clickTpEnabled then
        giveClickTpTool()
        sendNotification("Click TP", "ƒê√£ c·∫•p tool Click TP v√†o Backpack!")
    else
        if clickTpTool then
            clickTpTool:Destroy()
            clickTpTool = nil
        end
    end
end)

saveWaypointButton = CreateButton(ButtonFrame2Right, "Save Waypoint", function()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        savedWaypoint = LocalPlayer.Character.HumanoidRootPart.CFrame
        sendNotification("Waypoint", "ƒê√£ l∆∞u v·ªã tr√≠ hi·ªán t·∫°i!")
    else
        sendNotification("Waypoint", "Kh√¥ng th·ªÉ l∆∞u v·ªã tr√≠!")
    end
end)

tpWaypointButton = CreateButton(ButtonFrame2Right, "TP to Waypoint", function()
    if savedWaypoint and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.CFrame = savedWaypoint
        sendNotification("Waypoint", "ƒê√£ teleport t·ªõi v·ªã tr√≠ ƒë√£ l∆∞u!")
    else
        sendNotification("Waypoint", "Ch∆∞a c√≥ v·ªã tr√≠ ƒë∆∞·ª£c l∆∞u!")
    end
end)

spinbotButton = CreateButton(ButtonFrame2Right, "Spinbot: " .. (Config.SpinbotEnabled and "ON" or "OFF"), function()
    Config.SpinbotEnabled = not Config.SpinbotEnabled
    spinbotButton.Text = "Spinbot: " .. (Config.SpinbotEnabled and "ON" or "OFF")
    sendNotification("Spinbot", Config.SpinbotEnabled and "Enabled" or "Disabled")
end)

-- √î nh·∫≠p Speed
local spinbotSpeedBox = Instance.new("TextBox")
spinbotSpeedBox.Size = UDim2.new(1, 0, 0, 20)
spinbotSpeedBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
spinbotSpeedBox.TextColor3 = Color3.new(1, 1, 1)
spinbotSpeedBox.Text = tostring(Config.SpinbotSpeed)
spinbotSpeedBox.PlaceholderText = "Speed"
spinbotSpeedBox.ClearTextOnFocus = false
spinbotSpeedBox.Font = Enum.Font.GothamBold
spinbotSpeedBox.TextSize = 12
spinbotSpeedBox.Parent = ButtonFrame2Right
Instance.new("UICorner", spinbotSpeedBox).CornerRadius = UDim.new(0, 4)

spinbotSpeedBox.FocusLost:Connect(function()
    local num = tonumber(spinbotSpeedBox.Text)
    if num then
        Config.SpinbotSpeed = num
    else
        spinbotSpeedBox.Text = tostring(Config.SpinbotSpeed)
    end
end)

antiFlingButton = CreateButton(ButtonFrame2Right, "Anti Fling: " .. (antiFlingEnabled and "ON" or "OFF"), function()
    antiFlingEnabled = not antiFlingEnabled
    antiFlingButton.Text = "Anti Fling: " .. (antiFlingEnabled and "ON" or "OFF")
    sendNotification("Anti Fling", antiFlingEnabled and "Enabled" or "Disabled")
end)

flintTouchButton = CreateButton(ButtonFrame2Right, "FlintTouch: OFF", function()
    hiddenFling = not hiddenFling
    sendNotification("FLINGTOUCH", hiddenFling and "ON" or "OFF")
    flintTouchButton.Text = "FlintTouch: " .. (hiddenFling and "ON" or "OFF")
end)

rejoinButton = CreateButton(ButtonFrame2Right, "Rejoin", function()
    TeleportService:Teleport(game.PlaceId, LocalPlayer)
end)

serverHopButton = CreateButton(ButtonFrame2Right, "Server Hop", function()
    local servers = getServers(game.PlaceId)
    if #servers > 0 then
        local randomServer = servers[math.random(1, #servers)]
        TeleportService:TeleportToPlaceInstance(game.PlaceId, randomServer.id, LocalPlayer)
    else
        sendNotification("DhuyxDtuyen", "No other servers found!")
    end
end)

setSpawnButton = CreateButton(ButtonFrame2Right, "Set Spawn Point", function()
    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if hrp then
        spawnPoint = hrp.CFrame
        sendNotification("DhuyxDtuyen", "Spawn point set to current position!")
    else
        sendNotification("DhuyxDtuyen", "Cannot set spawn point!")
    end
end)

--// Connections and Loops
RunService.RenderStepped:Connect(function(dt) lastDt = dt end)

RunService.Heartbeat:Connect(function(dt)
    if AscendEnabled then
        local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if hrp then
            local step = AscendSpeed * dt
            hrp.CFrame = hrp.CFrame + Vector3.new(0, step, 0)
        end
    end
end)

if _G.__vhuyhub_antilock_conn then
    _G.__vhuyhub_antilock_conn:Disconnect()
end

_G.__vhuyhub_antilock_conn = RunService.Heartbeat:Connect(function()
    if not Config.AntiLockEnabled then return end

    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local dir = Vector3.new(0, 0, -1) -- default Behind
    local t = Config.AntiLockType
    if     t == "Behind"  then dir = Vector3.new(0,  0, -1)
    elseif t == "Down"    then dir = Vector3.new(0, -1,  0)
    elseif t == "Forward" then dir = Vector3.new(0,  0,  1)
    elseif t == "Left"    then dir = Vector3.new(-1, 0,  0)
    elseif t == "One"     then dir = Vector3.new(1,  1,  1)
    elseif t == "Right"   then dir = Vector3.new(1,  0,  0)
    elseif t == "Up"      then dir = Vector3.new(0,  1,  0)
    elseif t == "Zero"    then dir = Vector3.new(0,  0,  0)
    end

    local oldVel = hrp.Velocity
    hrp.Velocity = dir * (2^16)
    RunService.RenderStepped:Wait()
    if hrp and hrp.Parent then
        hrp.Velocity = oldVel
    end
end)

if noSlowConnection then noSlowConnection:Disconnect() end
noSlowConnection = RunService.Heartbeat:Connect(applyNoSlowdown)

LocalPlayer.CharacterAdded:Connect(function(newChar)
    if Config.NoSlowdownEnabled then
        task.wait(0.5) -- ƒê·ª£i nh√¢n v·∫≠t load ƒë·∫ßy ƒë·ªß
        applyNoSlowdown()
    end
end)

UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == Enum.KeyCode.Y then
        autoSelect = not autoSelect
        if autoSelect then
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer then
                    Config.SelectedPlayers[player.Name] = true
                end
            end
        else
            Config.SelectedPlayers = {}
        end
        UpdatePlayerList(PlayerListFrame)
    end
end)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if input.UserInputType == Enum.UserInputType.MouseButton2 and not gameProcessed then
        getgenv().Aimbot.Status = true
    end
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        getgenv().Aimbot.Status = false
    end
end)

LocalPlayer.CharacterAdded:Connect(function()
    hugEnabled = false
    stopAnim()
    hugButton.Text = "HugR6: OFF"
end)

game:GetService("RunService").Stepped:Connect(function()
    if not getgenv().CustomAnimEnabled then return end
    local char = game.Players.LocalPlayer.Character
    if char and char:FindFirstChild("Animate") then
        local anim = char.Animate
        -- Ch·∫°y
        anim.run.RunAnim.AnimationId = "http://www.roblox.com/asset/?id=616163682"
        -- Nh·∫£y
        anim.jump.JumpAnim.AnimationId = "http://www.roblox.com/asset/?id=10921242013"
        -- R∆°i
        anim.fall.FallAnim.AnimationId = "http://www.roblox.com/asset/?id=707829716"
    end
end)

LocalPlayer.CharacterAdded:Connect(function()
    if piggyEnabled then
        task.wait(0.5)
        local target = getClosestSelected()
        if not target then
            stopPiggy()
            return
        end
        startPiggy(target)
    end
end)

LocalPlayer.CharacterAdded:Connect(function()
    if animEnabled then
        task.wait(0.5) 
        local target = getClosestSelected()
        if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
            local myChar = LocalPlayer.Character
            local myHum = myChar and myChar:FindFirstChildOfClass("Humanoid")
            local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
            if myHum and myHRP then
                -- Ch·ªçn l·∫°i animation theo rig type
                local anim = Instance.new("Animation")
                anim.AnimationId = myHum.RigType == Enum.HumanoidRigType.R6 and "rbxassetid://148840371" or "rbxassetid://5918726674"

                -- Ph√°t l·∫°i animation
                animTrack = myHum:LoadAnimation(anim)
                animTrack:Play()
                animTrack:AdjustSpeed(10)

                -- Teleport li√™n t·ª•c
                bangConnection = RunService.Heartbeat:Connect(function()
                    if animEnabled and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                        myHRP.CFrame = target.Character.HumanoidRootPart.CFrame * CFrame.new(0, 0, 1)
                    else
                        stopAnimAndTp()
                        bangButton.Text = "BangPlayer: OFF"
                    end
                end)
            end
        else
            stopAnimAndTp()
            bangButton.Text = "BangPlayer: OFF"
        end
    end
end)

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(0.5) -- ƒê·ª£i nh√¢n v·∫≠t load
    applyFOV()
end)

if fovConnection then fovConnection:Disconnect() end
fovConnection = RunService.Heartbeat:Connect(function()
    if Config.CustomFOVEnabled and Workspace.CurrentCamera.FieldOfView ~= Config.CustomFOV then
        applyFOV()
    end
end)

LocalPlayer.CharacterAdded:Connect(function()
    if Config.NoclipEnabled then
        task.wait(0.5) -- ƒë·ª£i nh√¢n v·∫≠t load
        noclipConnection = RunService.Stepped:Connect(function()
            local char = LocalPlayer.Character
            if char and char:FindFirstChildOfClass("Humanoid") then
                for _, part in ipairs(char:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
            end
        end)
    end
end)

LocalPlayer.CharacterAdded:Connect(function()
    currentTrack = nil
end)

-- Li√™n t·ª•c ki·ªÉm tra n·∫øu b·∫Øt ƒë·∫ßu di chuy·ªÉn th√¨ d·ª´ng animation
RunService.RenderStepped:Connect(function()
    local char = LocalPlayer.Character
    if char and currentTrack then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum and hum.MoveDirection.Magnitude > 0 then
            stopAnimation()
        end
    end
end)

updateCharacterRefs()
LocalPlayer.CharacterAdded:Connect(updateCharacterRefs)

RunService.Heartbeat:Connect(function()
    if Config.AutoWallhopEnabled then
        performWallHop()
    end
end)

LocalPlayer.CharacterAdded:Connect(function()
    if Config.clickTpEnabled then
        task.wait(0.5) -- ƒë·ª£i nh√¢n v·∫≠t load
        giveClickTpTool()
    end
end)

RunService.RenderStepped:Connect(function(delta)
    if Config.SpinbotEnabled then
        local char = LocalPlayer.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        local hum = char and char:FindFirstChild("Humanoid")
        if hrp and hum then
            hrp.CFrame = hrp.CFrame * CFrame.Angles(0, math.rad(Config.SpinbotSpeed) * delta, 0)
            hum.AutoRotate = false
        end
    else
        local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid")
        if hum then hum.AutoRotate = true end
    end
end)

LocalPlayer.CharacterAdded:Connect(function()
    protectHRP()
end)
protectHRP()

RunService.Heartbeat:Connect(function()
    if antiFlingEnabled and hrp then
        -- ch·∫∑n velocity qu√° cao
        if hrp.AssemblyLinearVelocity.Magnitude > 100 then
            hrp.AssemblyLinearVelocity = Vector3.zero
        end
        if hrp.AssemblyAngularVelocity.Magnitude > 100 then
            hrp.AssemblyAngularVelocity = Vector3.zero
        end

        -- n·∫øu b·ªã ƒë·∫©y qu√° xa trong 1 tick -> ƒë∆∞a v·ªÅ v·ªã tr√≠ c≈©
        if lastPos and (hrp.Position - lastPos).Magnitude > 40 then
            hrp.CFrame = CFrame.new(lastPos)
            hrp.AssemblyLinearVelocity = Vector3.zero
            hrp.AssemblyAngularVelocity = Vector3.zero
        end
        lastPos = hrp.Position
    end
end)

RunService.Heartbeat:Connect(function()
    if not Config.RainbowHitEffectEnabled then return end

    for name, selected in pairs(Config.SelectedPlayers or {}) do
        if selected then
            local plr = Players:FindFirstChild(name)
            local char = plr and plr.Character
            local hum = char and char:FindFirstChildOfClass("Humanoid")
            if hum then
                local current = hum.Health
                local last = lastHealth[name] or current

                if current < last then
                    -- L·∫•y highlight c≈© ho·∫∑c t·∫°o m·ªõi
                    local highlight = char:FindFirstChild("HitEffectHighlight")
                    if not highlight then
                        highlight = Instance.new("Highlight")
                        highlight.Name = "HitEffectHighlight"
                        highlight.Adornee = char
                        highlight.FillTransparency = 1
                        highlight.OutlineTransparency = 0
                        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                        highlight.Parent = char
                    end

                    -- Hi·ªáu ·ª©ng rainbow trong 1 gi√¢y
                    task.spawn(function()
                        local start = tick()
                        while tick() - start < 1 and highlight.Parent do
                            highlight.OutlineColor = fadeColor()
                            task.wait(0.05)
                        end
                        highlight:Destroy()
                    end)
                end

                lastHealth[name] = current
            end
        end
    end
end)

game:GetService("RunService").Heartbeat:Connect(function()
    for name, selected in pairs(Config.SelectedPlayers) do
        if selected then
            local plr = Players:FindFirstChild(name)
            if plr then
                checkPlayerState(plr)
            end
        end
    end
end)

flingLoop()

LocalPlayer.CharacterAdded:Connect(function(char)
    if spawnPoint then
        local hrp = char:WaitForChild("HumanoidRootPart", 5)
        if hrp then
            task.wait(0.2)  -- ƒê·ª£i load ƒë·∫ßy ƒë·ªß
            hrp.CFrame = spawnPoint
        end
    end
end)

RunService.RenderStepped:Connect(function(deltaTime)
    UpdateESP()
    UpdateSpeed()
    UpdateFly(deltaTime)
    UpdateAimbot()
    UpdateHitbox()
    UpdateTriggerBot()
    UpdateAngelWing()
end)

game.Players.LocalPlayer.CharacterAdded:Connect(function(char)
    char:WaitForChild("HumanoidRootPart", 5)
    if AngelWingEnabled then
        createAw()
    end
end)

if _G.VHUB_CSYNC_LOOP then _G.VHUB_CSYNC_LOOP:Disconnect() end
_G.VHUB_CSYNC_LOOP = RunService.Heartbeat:Connect(function(deltaTime)
    if not (Config.CsyncRandomEnabled or Config.CsyncOrbitEnabled) then
        csyncPaused = true
        return
    end

    -- T√¨m target m·ªõi n·∫øu c·∫ßn
    if not currentTarget or not currentTarget.Parent or not isAlive(currentTarget) then
        currentTarget = GetClosestTarget()
        if not currentTarget then
            csyncPaused = true
            print("Debug: Csync paused - no valid target")
            return
        end
    end

    -- Ki·ªÉm tra nh√¢n v·∫≠t v√† HumanoidRootPart
    local hrp = currentTarget.Character and currentTarget.Character:FindFirstChild("HumanoidRootPart")
    local myHRP = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp or not myHRP then
        csyncPaused = true
        print("Debug: Missing HRP for local or target player")
        return
    end

    csyncPaused = false
    local targetPos = hrp.Position

    -- Csync Orbit
    if Config.CsyncOrbitEnabled then
        local t = tick() * (Config.CsyncSpeed or 1)
        local offset = Vector3.new(
            math.cos(t) * (Config.CsyncRadius or 10),
            Config.CsyncHeight or 0,
            math.sin(t) * (Config.CsyncRadius or 10)
        )
        myHRP.CFrame = CFrame.new(targetPos + offset, targetPos)
        print("Debug: Orbiting at position:", (targetPos + offset))

    -- Csync Random
    elseif Config.CsyncRandomEnabled then
        local offset = Vector3.new(
            math.random(-(Config.CsyncRadius or 10), Config.CsyncRadius or 10),
            Config.CsyncHeight or 0,
            math.random(-(Config.CsyncRadius or 10), Config.CsyncRadius or 10)
        )
        myHRP.CFrame = CFrame.new(targetPos + offset, targetPos)
        print("Debug: Random position:", (targetPos + offset))
    end
end)

Players.PlayerRemoving:Connect(function(player)
    RemoveESP(player)
    UpdatePlayerList(PlayerListFrame)
end)

Players.PlayerAdded:Connect(function(player)
    task.wait(math.random(2, 3))
    RemoveESP(player)
    if Config.SelectedPlayers[player.Name] then
        Config.SelectedPlayers[player.Name] = true 
    end
    UpdatePlayerList(PlayerListFrame)
end)

task.spawn(function()
    while true do
        UpdatePlayerList(PlayerListFrame)
        task.wait(math.random(12, 15))
    end
end)

-- === N√∫t Select Target ===
if UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled then
    -- T·∫°o n√∫t n·ªïi ngo√†i m√†n h√¨nh
    local selectGui = Instance.new("ScreenGui")
    selectGui.Name = "SelectTargetGui"
    selectGui.ResetOnSpawn = false -- ch·∫øt kh√¥ng m·∫•t
    selectGui.Parent = CoreGui

    local selectBtn = Instance.new("TextButton")
    selectBtn.Size = UDim2.new(0, 110, 0, 35)
    selectBtn.Position = UDim2.new(0, 300, 0, 200)
    selectBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    selectBtn.Text = "Set Target"
    selectBtn.Font = Enum.Font.GothamBold
    selectBtn.TextSize = 14
    selectBtn.TextColor3 = Color3.new(230, 230, 230)
    selectBtn.Parent = selectGui
    Instance.new("UICorner", selectBtn).CornerRadius = UDim.new(0, 8)
    makeSmoothDraggable(selectBtn, 0.2)

    -- Cho ph√©p k√©o n√∫t
    local dragging, dragStart, startPos
    selectBtn.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = selectBtn.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            selectBtn.Position = UDim2.new(
                startPos.X.Scale, startPos.X.Offset + delta.X,
                startPos.Y.Scale, startPos.Y.Offset + delta.Y
            )
        end
    end)

    -- X·ª≠ l√Ω khi click
    selectBtn.MouseButton1Click:Connect(function()
        local target = GetClosestValidPlayer()
        if target then
            local displayName = target.DisplayName
            local username = target.Name
            local label = tostring(displayName or username) .. " (@" .. tostring(username) .. ")"

            if Config.SelectedPlayers[username] then
                Config.SelectedPlayers[username] = nil
                sendNotification("DhuyxDtuyen", "UnTarget: " .. label, 2)
            else
                Config.SelectedPlayers[username] = true
                sendNotification("DhuyxDtuyen", "Target: " .. label, 2)
            end

            UpdatePlayerList(PlayerListFrame)
        else
            sendNotification("DhuyxDtuyen", "No target found in FOV", 2)
        end
    end)
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.MouseButton3 then -- Chu·ªôt gi·ªØa
        local target = GetClosestValidPlayer()
        if target then
            local displayName = target.DisplayName
            local username = target.Name
            local label = tostring(displayName or username) .. " (@" .. tostring(username) .. ")"

            if Config.SelectedPlayers[username] then
                Config.SelectedPlayers[username] = nil
                sendNotification("DhuyxDtuyent", "UnTarget: " .. label, 2)
            else
                Config.SelectedPlayers[username] = true
                sendNotification("DhuyxDtuyen", "Target: " .. label, 2)
            end

            UpdatePlayerList(PlayerListFrame)
        else
            sendNotification("DhuyxDtuyen", "No target found in FOV", 2)
        end
    end
end)